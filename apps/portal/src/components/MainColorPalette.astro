---
import * as styles from "@harnessio/core-design-system/styles-esm";
import colorsHex from "../../../../packages/core-design-system/design-tokens/core/colors_hex.json";

interface ColorToken {
  name?: string;
  $value?: string;
  $type?: string;
  [key: string]: unknown;
}

// Get shade keys from blue (representative color)
const shades = Object.keys(styles.colors.blue).filter((k) => k !== "$type");
const colorNames = Object.keys(styles.colors).filter((c) => c !== "pure");

// Build color data with both LCH and HEX
const colorData = colorNames.map((colorName) => {
  const lchGroup = styles.colors[colorName as keyof typeof styles.colors];
  const hexGroup = colorsHex[colorName as keyof typeof colorsHex];

  const shadeData = shades.map((shade) => {
    const lchToken = lchGroup[shade as keyof typeof lchGroup] as ColorToken;
    const hexToken = hexGroup?.[shade as keyof typeof hexGroup] as
      | { $value?: string }
      | undefined;

    return {
      shade,
      lch: lchToken?.$value || "",
      hex: hexToken?.$value || "",
      cssVar: lchToken?.name
        ? `var(--${lchToken.name})`
        : `var(--cn-${colorName}-${shade})`,
      cssVarName: lchToken?.name || `cn-${colorName}-${shade}`,
    };
  });

  return {
    name: colorName,
    shades: shadeData,
  };
});

const colorDataJson = JSON.stringify(colorData);
---

<div class="not-content color-palette-container">
  <!-- Format Selector -->
  <div class="format-selector">
    <span class="format-label">Copy as:</span>
    <div class="format-buttons">
      <button type="button" class="format-btn active" data-format="var"
        >Variable</button
      >
      <button type="button" class="format-btn" data-format="lch">LCH</button>
      <button type="button" class="format-btn" data-format="hex">HEX</button>
    </div>
  </div>

  <!-- Color Grid -->
  <div class="color-grid">
    <!-- Header -->
    <div class="grid-header">
      <div class="color-name-cell"></div>
      {shades.map((shade) => <div class="shade-header">{shade}</div>)}
    </div>

    <!-- Color Rows -->
    {
      colorData.map((color) => (
        <div class="color-row">
          <div class="color-name-cell">
            <span class="color-name">{color.name}</span>
          </div>
          {color.shades.map((s) => (
            <div class="swatch-cell">
              <button
                type="button"
                class="swatch"
                style={`background-color: ${s.lch};`}
                data-lch={s.lch}
                data-hex={s.hex}
                data-var={s.cssVar}
                data-name={`${color.name}-${s.shade}`}
              >
                <span class="swatch-tooltip">
                  <span class="tooltip-value" data-type="lch">
                    {s.lch}
                  </span>
                </span>
              </button>
            </div>
          ))}
        </div>
      ))
    }
  </div>

  <!-- Toast -->
  <div class="copy-toast" id="copyToast">
    <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
      <path
        d="M13.5 4.5L6 12L2.5 8.5"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"></path>
    </svg>
    <span id="toastMessage">Copied!</span>
  </div>
</div>

<style>
  .color-palette-container {
    --name-width: 64px;
    --gap: 3px;
    --radius: 5px;
  }

  /* Format Selector */
  .format-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }

  .format-label {
    font-size: 12px;
    color: var(--sl-color-gray-3);
  }

  .format-buttons {
    display: inline-flex;
    background: var(--sl-color-gray-6);
    border-radius: 8px;
    padding: 2px;
    gap: 1px;
  }

  .format-btn {
    padding: 3px 10px;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    background: transparent;
    color: var(--sl-color-gray-3);
  }

  .format-btn:hover {
    color: var(--sl-color-gray-1);
  }

  .format-btn.active {
    background: var(--sl-color-bg);
    color: var(--sl-color-white);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  /* Color Grid */
  .color-grid {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
  }

  .grid-header,
  .color-row {
    display: grid;
    grid-template-columns: var(--name-width) repeat(15, 1fr);
    gap: var(--gap);
    align-items: center;
  }

  .shade-header {
    font-size: 10px;
    font-weight: 500;
    color: var(--sl-color-gray-2);
    text-align: center;
  }

  .color-name-cell {
    padding-right: 8px;
  }

  .color-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--sl-color-gray-2);
    text-transform: capitalize;
  }

  /* Swatch */
  .swatch-cell {
    position: relative;
  }

  .swatch {
    width: 100%;
    aspect-ratio: 1.4;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition:
      box-shadow 0.1s ease,
      outline 0.1s ease;
    position: relative;
    padding: 0;
  }

  .swatch:hover {
    box-shadow:
      0 0 0 2px var(--sl-color-white),
      0 0 0 4px currentColor;
    z-index: 10;
  }

  .swatch:active {
    opacity: 0.9;
  }

  /* Tooltip - inverted colors */
  .swatch-tooltip {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--sl-color-text);
    border-radius: 6px;
    padding: 3px 8px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.1s ease;
    pointer-events: none;
    white-space: nowrap;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .swatch:hover .swatch-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .tooltip-value {
    font-size: 10px;
    line-height: 1;
    font-family: ui-monospace, monospace;
    color: var(--sl-color-bg);
  }

  /* Toast - inverted colors */
  .copy-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(12px);
    background: var(--sl-color-text);
    border-radius: 8px;
    padding: 6px 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: all 0.15s ease;
    z-index: 1000;
  }

  .copy-toast.show {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .copy-toast svg {
    color: #22c55e;
  }

  #toastMessage {
    font-size: 11px;
    font-weight: 500;
    font-family: ui-monospace, monospace;
    color: var(--sl-color-bg);
  }
</style>

<script is:inline>
  (function () {
    let currentFormat = "var";

    function init() {
      const formatBtns = document.querySelectorAll(".format-btn");
      const swatches = document.querySelectorAll(".swatch");
      const toast = document.getElementById("copyToast");
      const toastMessage = document.getElementById("toastMessage");
      const tooltipValues = document.querySelectorAll(".tooltip-value");

      // Update tooltip values based on format
      function updateTooltips() {
        swatches.forEach((swatch) => {
          const tooltip = swatch.querySelector(".tooltip-value");
          if (tooltip) {
            let value;
            if (currentFormat === "lch") {
              value = swatch.getAttribute("data-lch");
            } else if (currentFormat === "hex") {
              value = swatch.getAttribute("data-hex");
            } else {
              value = swatch.getAttribute("data-var");
            }
            tooltip.textContent = value || "";
          }
        });
      }

      // Format button clicks
      formatBtns.forEach((btn) => {
        btn.onclick = function () {
          formatBtns.forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          currentFormat = this.getAttribute("data-format");
          updateTooltips();
        };
      });

      // Swatch clicks
      swatches.forEach((swatch) => {
        swatch.onclick = function () {
          let value;
          if (currentFormat === "lch") {
            value = this.getAttribute("data-lch");
          } else if (currentFormat === "hex") {
            value = this.getAttribute("data-hex");
          } else {
            value = this.getAttribute("data-var");
          }

          if (navigator.clipboard && value) {
            navigator.clipboard.writeText(value).then(() => {
              if (toast && toastMessage) {
                toastMessage.textContent = "Copied: " + value;
                toast.classList.add("show");
                setTimeout(() => {
                  toast.classList.remove("show");
                }, 2000);
              }
            });
          }
        };
      });

      updateTooltips();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }

    document.addEventListener("astro:page-load", init);
  })();
</script>
