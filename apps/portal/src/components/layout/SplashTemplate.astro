---
import Search from "@astrojs/starlight/components/Search.astro";
import Sidebar from "@astrojs/starlight/components/Sidebar.astro";
import SidebarLogo from "./SidebarLogo.astro";
import ThemeSelect from "./ThemeSelect.astro";
---

<div class="flex min-h-screen bg-cn-1">
  <!-- Sidebar -->
  <nav
    class="cn-portal-sidebar flex flex-col w-[248px] shrink-0 sticky top-0 h-screen border-r border-cn-3"
  >
    <!-- Logo + Theme toggle -->
    <div class="cn-sidebar-header flex-shrink-0 flex items-center justify-between pr-cn-xs pt-cn-sm pb-cn-xs" style="padding-left: 16px;">
      <SidebarLogo />
      <div class="cn-sidebar-theme-toggle flex-shrink-0">
        <ThemeSelect />
      </div>
    </div>

    <!-- Search -->
    <div class="cn-sidebar-search flex-shrink-0 px-cn-xs pb-cn-xs">
      <Search />
    </div>

    <!-- Scrollable nav -->
    <div class="cn-sidebar-scroll flex-1 min-h-0 overflow-hidden">
      <div class="cn-sidebar-scroll-inner h-full overflow-y-auto overscroll-contain px-cn-xs pb-cn-md">
        <Sidebar />
      </div>
    </div>
  </nav>

  <!-- Content centered in remaining space -->
  <div class="flex-1 flex justify-center" style="padding-top: 20px;">
    <div class="w-full" style="max-width: 1060px; padding: 0 40px;">
      <slot />
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const selected = document.querySelector('.cn-sidebar-scroll-inner a[aria-current="page"]');
    if (selected) {
      selected.scrollIntoView({ block: 'center', behavior: 'instant' });
    }

    // Copy button enhancements (delayed to ensure EC has rendered)
    setTimeout(() => {
      document.querySelectorAll('.expressive-code').forEach((block) => {
        const lines = block.querySelectorAll('.ec-line');
        const copyDiv = block.querySelector('.copy');
        const btn = copyDiv?.querySelector('button');

        // Center copy button for single-line code blocks
        if (lines.length <= 1 && copyDiv) {
          const pre = block.querySelector('pre');
          if (pre) {
            const preRect = pre.getBoundingClientRect();
            const copyRect = copyDiv.getBoundingClientRect();
            const currentTop = copyRect.top - preRect.top;
            const targetTop = (preRect.height - copyRect.height) / 2;
            const offset = targetTop - currentTop;
            const currentInset = parseFloat(getComputedStyle(copyDiv).insetBlockStart) || 0;
            copyDiv.style.setProperty('inset-block-start', `${currentInset + offset}px`, 'important');
          }
        }

        // Swap icon to checkmark on click
        if (btn) {
          btn.addEventListener('click', () => {
            btn.classList.add('copied');
            setTimeout(() => btn.classList.remove('copied'), 2000);
          });
        }
      });
    }, 100);
  });
</script>
