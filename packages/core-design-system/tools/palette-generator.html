<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCH Token Editor - Display P3</title>
    <script src="https://cdn.jsdelivr.net/npm/culori@4.0.1/bundled/culori.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-0: #09090b;
            --bg-1: #111113;
            --bg-2: #18181b;
            --bg-3: #27272a;
            --border-1: #27272a;
            --border-2: #3f3f46;
            --text-1: #fafafa;
            --text-2: #a1a1aa;
            --text-3: #71717a;
            --accent: #8b5cf6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        /* Custom scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-0);
            color: var(--text-1);
            font-size: 12px;
            line-height: 1.4
        }

        .app {
            display: grid;
            grid-template-columns: 180px 1fr 280px;
            grid-template-rows: auto 1fr;
            min-height: 100vh
        }

        @media (min-width: 1400px) {
            .app {
                grid-template-columns: 200px 1fr 300px;
            }
        }

        @media (min-width: 1800px) {
            .app {
                grid-template-columns: 220px 1fr 320px;
            }
        }

        .header {
            grid-column: 1/-1;
            background: var(--bg-1);
            border-bottom: 1px solid var(--border-1);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .header h1 {
            font-size: 14px;
            font-weight: 600
        }

        .p3-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--bg-3);
            color: var(--text-2);
            margin-left: 8px
        }

        .sidebar {
            background: var(--bg-1);
            border-right: 1px solid var(--border-1);
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - 44px)
        }

        .main {
            padding: 12px 16px;
            overflow-y: auto;
            max-height: calc(100vh - 44px);
            display: flex;
            flex-direction: column
        }

        .panel {
            background: var(--bg-1);
            border-left: 1px solid var(--border-1);
            padding: 12px;
            overflow-y: auto;
            max-height: calc(100vh - 44px)
        }

        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid var(--border-2);
            background: var(--bg-2);
            color: var(--text-1);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: background .15s
        }

        .btn:hover {
            background: var(--bg-3)
        }

        .btn-primary {
            background: var(--accent);
            border-color: var(--accent)
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 10px;
            flex-shrink: 0;
        }

        .btn-primary:hover {
            background: #7c4ddb
        }

        kbd {
            display: inline-block;
            padding: 1px 4px;
            font-size: 9px;
            font-family: monospace;
            background: var(--bg-0);
            border: 1px solid var(--border-2);
            border-radius: 3px;
            margin-left: 4px;
            opacity: 0.7;
        }

        .section {
            margin-bottom: 12px
        }

        .section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-1)
        }

        .family-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer
        }

        .family-item:hover {
            background: var(--bg-2)
        }

        .family-item.active {
            background: var(--bg-3)
        }

        .family-swatch {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            flex-shrink: 0
        }

        .family-name {
            flex: 1;
            font-size: 11px;
            font-weight: 500;
            text-transform: capitalize
        }

        .family-hue {
            font-size: 9px;
            color: var(--text-3);
            font-family: monospace
        }

        .palette-header {
            display: flex;
            margin-left: 52px;
            margin-bottom: 4px;
            gap: 2px
        }

        .palette-header span {
            flex: 1;
            min-width: 36px;
            text-align: center;
            font-size: 9px;
            color: var(--text-3);
            font-weight: 500
        }

        .palette-row {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-bottom: 1px
        }

        .palette-label {
            width: 50px;
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-2);
            text-align: right;
            padding-right: 6px;
            text-transform: capitalize
        }

        .palette-shades {
            display: flex;
            gap: 2px;
            flex: 1
        }

        .shade {
            flex: 1;
            min-width: 36px;
            aspect-ratio: 1;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
            position: relative;
            font-size: 11px
        }

        .shade:hover {
            transform: scale(1.08);
            z-index: 10;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .4)
        }

        .shade.selected {
            outline: 2px solid var(--accent);
            outline-offset: 2px
        }

        .shade.oog::after {
            content: '!';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 10px;
            font-weight: 700;
            color: var(--danger)
        }

        .shade-l {
            font-size: 10px;
            font-weight: 600;
            opacity: .9
        }

        .shade-c {
            font-size: 8px;
            opacity: .6
        }

        .form-group {
            margin-bottom: 10px
        }

        .form-label {
            font-size: 10px;
            color: var(--text-2);
            margin-bottom: 4px;
            display: block
        }

        .form-row {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .form-input {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-1);
            background: var(--bg-2);
            color: var(--text-1);
            font-size: 11px;
            font-family: monospace
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent)
        }

        .form-input-sm {
            width: 52px;
            text-align: center;
            flex-shrink: 0;
        }

        .slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-3);
            border-radius: 2px
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer
        }

        .color-preview {
            width: 100%;
            height: 56px;
            border-radius: 6px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            position: relative
        }

        .gamut-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500
        }

        .gamut-tag.ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success)
        }

        .gamut-tag.oog {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger)
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-1);
            font-size: 11px
        }

        .detail-label {
            color: var(--text-2)
        }

        .detail-value {
            font-family: monospace;
            font-size: 10px
        }

        .values-grid {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .value-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            background: var(--bg-2);
            border-radius: 4px;
        }

        .value-label {
            font-size: 10px;
            color: var(--text-3);
        }

        .value-data {
            font-size: 10px;
            font-family: monospace;
            color: var(--text-1);
        }

        .contrast-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .contrast-card {
            background: var(--bg-2);
            border-radius: 6px;
            padding: 8px
        }

        .contrast-card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .contrast-swatch {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            border: 1px solid var(--border-2);
            flex-shrink: 0;
        }

        .contrast-card-info {
            flex: 1;
            min-width: 0;
        }

        .contrast-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-2);
        }

        .contrast-lch {
            font-size: 8px;
            color: var(--text-3);
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contrast-ratio {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .contrast-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .badge {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            margin-right: 2px
        }

        .badge.pass {
            background: rgba(34, 197, 94, .2);
            color: var(--success)
        }

        .badge.fail {
            background: rgba(239, 68, 68, .2);
            color: var(--danger)
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200
        }

        .modal-overlay.open {
            display: flex
        }

        .modal {
            background: var(--bg-1);
            border-radius: 8px;
            border: 1px solid var(--border-1);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-1);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-2);
            font-size: 20px;
            cursor: pointer
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px)
        }

        .modal-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px
        }

        .modal-tab {
            padding: 8px 14px;
            border-radius: 6px;
            background: var(--bg-2);
            border: 1px solid var(--border-1);
            color: var(--text-2);
            cursor: pointer;
            font-size: 12px
        }

        .modal-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff
        }

        .export-code {
            background: var(--bg-0);
            border: 1px solid var(--border-1);
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.6;
            overflow: auto;
            white-space: pre;
            max-height: 350px
        }

        .p3-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-2);
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 12px
        }

        .p3-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%
        }

        .p3-dot.on {
            background: var(--success)
        }

        .p3-dot.off {
            background: var(--warning)
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-2);
            border: 1px solid var(--border-1);
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 13px;
            z-index: 300
        }

        .sync-help {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-2);
            border: 1px solid var(--border-1);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 12px;
            width: 300px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .sync-help.show {
            display: block;
        }

        .sync-help-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-1);
        }

        .sync-help-text {
            color: var(--text-3);
            line-height: 1.5;
        }

        /* Compare Mode Styles */
        .compare-section {
            margin-bottom: 16px;
        }

        .compare-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .compare-tab {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background: var(--bg-2);
            border: 1px solid var(--border-1);
            color: var(--text-2);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }

        .compare-tab:hover {
            background: var(--bg-3);
        }

        .compare-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .compare-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .compare-stat {
            flex: 1;
            padding: 8px;
            background: var(--bg-2);
            border-radius: 6px;
            text-align: center;
        }

        .compare-stat-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .compare-stat-label {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
        }

        .compare-stat.changed .compare-stat-value {
            color: var(--warning);
        }

        .compare-stat.unchanged .compare-stat-value {
            color: var(--text-3);
        }

        .shade-diff {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.4);
            white-space: nowrap;
        }

        .shade-diff.changed {
            background: var(--warning);
            color: #000;
        }

        .shade-diff.new {
            background: var(--success);
            color: #000;
        }

        .compare-preview {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .compare-preview-item {
            flex: 1;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .compare-preview-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .compare-preview-value {
            font-family: monospace;
            font-size: 11px;
        }

        .delta-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-1);
            font-size: 12px;
        }

        .delta-label {
            color: var(--text-2);
        }

        .delta-value {
            font-family: monospace;
            font-size: 11px;
        }

        .delta-value.positive {
            color: var(--success);
        }

        .delta-value.negative {
            color: var(--danger);
        }

        .delta-value.neutral {
            color: var(--text-3);
        }

        /* Full Palette Compare Modal */
        .compare-modal {
            width: calc(100vw - 40px);
            height: calc(100vh - 40px);
            max-width: none;
            max-height: none;
            display: flex;
            flex-direction: column;
        }

        .compare-modal .modal-header {
            flex-shrink: 0;
        }

        .compare-modal .modal-body {
            flex: 1;
            padding: 16px 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .compare-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .compare-info {
            font-size: 13px;
            color: var(--text-2);
        }

        .compare-info strong {
            color: var(--text-1);
        }

        .compare-scroll {
            flex: 1;
            overflow: auto;
            border-radius: 8px;
            background: var(--bg-0);
            padding: 16px;
        }

        .full-compare {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .full-compare-header {
            display: flex;
            margin-left: 72px;
            gap: 3px;
            margin-bottom: 6px;
            position: sticky;
            top: 0;
            background: var(--bg-0);
            padding-bottom: 6px;
            z-index: 1;
        }

        .full-compare-header span {
            flex: 1;
            min-width: 50px;
            max-width: 70px;
            text-align: center;
            font-size: 11px;
            color: var(--text-3);
            font-weight: 500;
        }

        .full-compare-row {
            display: flex;
            align-items: stretch;
            gap: 3px;
        }

        .full-compare-label {
            width: 64px;
            font-size: 12px;
            color: var(--text-2);
            text-align: right;
            padding-right: 8px;
            text-transform: capitalize;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .full-compare-shades {
            display: flex;
            gap: 3px;
            flex: 1;
        }

        .compare-shade-pair {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 50px;
            max-width: 70px;
            cursor: pointer;
            border-radius: 6px;
            overflow: hidden;
        }

        .compare-shade-pair:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .compare-shade {
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .compare-shade.old {
            border-radius: 0;
        }

        .compare-shade.new {
            border-radius: 0;
        }

        .compare-shade-pair.same {
            opacity: 0.35;
        }

        .compare-shade-pair.same:hover {
            opacity: 0.6;
        }

        .changes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .change-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-2);
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .change-item:hover {
            background: var(--bg-3);
        }

        .change-swatches {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .change-swatch {
            width: 28px;
            height: 28px;
            border-radius: 4px;
        }

        .change-arrow {
            color: var(--text-3);
            font-size: 14px;
        }

        .change-info {
            flex: 1;
        }

        .change-name {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .change-delta {
            font-size: 10px;
            color: var(--text-3);
            font-family: monospace;
        }

        .no-changes {
            text-align: center;
            padding: 40px;
            color: var(--text-3);
        }

        .no-changes-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        /* Contrast Shades */
        .contrast-shades {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .contrast-shade-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: var(--bg-2);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .contrast-shade-item:hover {
            background: var(--bg-3);
        }

        .contrast-shade-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .contrast-shade-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .contrast-shade-name {
            font-size: 11px;
            color: var(--text-2);
        }

        .contrast-shade-ratio {
            font-size: 12px;
            font-weight: 600;
            font-family: monospace;
        }

        .contrast-shade-ratio.pass {
            color: var(--success);
        }

        .contrast-shade-ratio.fail {
            color: var(--text-3);
        }

        /* Contrast Row (below palette) */
        .contrast-row {
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-1);
            border-radius: 6px;
            border: 1px solid var(--border-1);
        }

        .contrast-row-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-2);
        }

        .contrast-row-shades {
            display: flex;
            gap: 2px;
        }

        .contrast-cell {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 4px 2px;
            background: var(--bg-2);
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .contrast-cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .contrast-cell.empty {
            opacity: 0.3;
            cursor: default;
        }

        .contrast-cell-shade {
            font-size: 8px;
            color: var(--text-3);
            font-weight: 500;
        }

        .contrast-cell-swatch {
            width: 100%;
            height: 14px;
            border-radius: 3px;
        }

        .contrast-cell-ratio {
            font-size: 10px;
            font-weight: 600;
            font-family: monospace;
            color: var(--text-1);
        }

        .contrast-cell-level {
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .contrast-cell.aaa .contrast-cell-level {
            background: var(--success);
            color: #000;
        }

        .contrast-cell.aa .contrast-cell-level {
            background: #4ade80;
            color: #000;
        }

        .contrast-cell.aal .contrast-cell-level {
            background: #fbbf24;
            color: #000;
        }

        .contrast-cell.fail .contrast-cell-level {
            background: var(--bg-3);
            color: var(--text-3);
        }

        /* Suggestion Row (inline fix preview) */
        .suggestion-row {
            margin-top: 6px;
            padding: 6px 8px;
            background: var(--bg-2);
            border-radius: 4px;
            border: 1px solid var(--border-1);
        }

        .suggestion-row.gentle {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .suggestion-row.warning {
            border-color: var(--warning);
            background: rgba(251, 191, 36, 0.05);
        }

        .suggestion-preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .suggestion-pair {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .suggestion-swatch {
            width: 40px;
            height: 28px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .suggestion-swatch.current {
            opacity: 0.6;
        }

        .suggestion-vs {
            font-size: 12px;
            color: var(--text-3);
        }

        .suggestion-delta {
            font-size: 12px;
            font-family: monospace;
            font-weight: 600;
            padding: 4px 8px;
            background: var(--bg-3);
            border-radius: 4px;
        }

        .suggestion-delta.positive {
            color: var(--success);
        }

        .suggestion-delta.negative {
            color: var(--danger);
        }

        .suggestion-result-inline {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .suggestion-result-inline.pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .suggestion-warn {
            font-size: 10px;
            color: var(--warning);
            margin-left: auto;
        }

        .contrast-cell.target {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
        }

        .contrast-hint {
            margin-top: 6px;
            padding: 8px;
            background: var(--bg-2);
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-3);
            text-align: center;
        }

        /* Family Dropdown */
        .family-dropdown {
            position: relative;
            margin-left: 8px;
        }

        .family-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-2);
            border: 1px solid var(--border-1);
            border-radius: 4px;
            color: var(--text-1);
            font-size: 11px;
            cursor: pointer;
        }

        .family-dropdown-btn:hover {
            background: var(--bg-3);
        }

        .family-dropdown-swatch {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .family-dropdown-arrow {
            font-size: 10px;
            color: var(--text-3);
        }

        .family-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-1);
            border: 1px solid var(--border-1);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            max-height: 240px;
            overflow-y: auto;
            min-width: 120px;
        }

        .family-dropdown-menu.open {
            display: block;
        }

        .family-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            font-size: 11px;
            cursor: pointer;
        }

        .family-dropdown-item:hover {
            background: var(--bg-2);
        }

        .family-dropdown-item.active {
            background: var(--accent);
            color: #000;
        }

        .suggestion-row.pass {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.05);
        }

        .suggestion-row.fail {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .suggestion-result {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .suggestion-result.pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .suggestion-result.fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .suggestion-result .badge {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .suggestion-result.pass .badge {
            background: var(--success);
            color: #000;
        }

        .suggestion-result.fail .badge {
            background: var(--danger);
            color: #fff;
        }

        /* Contrast Fix Modal */
        .fix-modal {
            width: calc(100vw - 80px);
            max-width: 900px;
            max-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .fix-modal .modal-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .fix-header {
            display: flex;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--bg-2);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .fix-source,
        .fix-target {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fix-swatch {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            border: 2px solid var(--border-2);
        }

        .fix-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .fix-name {
            font-weight: 600;
            font-size: 14px;
        }

        .fix-lch {
            font-size: 11px;
            color: var(--text-3);
            font-family: monospace;
        }

        .fix-arrow {
            font-size: 20px;
            color: var(--text-3);
        }

        .fix-problems {
            margin-bottom: 20px;
        }

        .fix-problem-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--bg-2);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .fix-problem-swatch {
            width: 32px;
            height: 32px;
            border-radius: 4px;
        }

        .fix-problem-info {
            flex: 1;
        }

        .fix-problem-name {
            font-size: 12px;
            font-weight: 500;
        }

        .fix-problem-ratio {
            font-size: 11px;
            color: var(--danger);
            font-family: monospace;
        }

        .fix-suggestions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fix-suggestion {
            background: var(--bg-2);
            border-radius: 8px;
            padding: 16px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.15s;
        }

        .fix-suggestion:hover {
            border-color: var(--accent);
        }

        .fix-suggestion.selected {
            border-color: var(--success);
        }

        .fix-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fix-suggestion-title {
            font-weight: 600;
            font-size: 13px;
        }

        .fix-suggestion-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .fix-suggestion-badge.recommended {
            background: var(--success);
            color: #000;
        }

        .fix-suggestion-badge.alternative {
            background: var(--warning);
            color: #000;
        }

        .fix-suggestion-preview {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .fix-before-after {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fix-ba-label {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
        }

        .fix-ba-swatch {
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        .fix-delta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-2);
            font-family: monospace;
        }

        .fix-delta-item {
            display: flex;
            gap: 4px;
        }

        .fix-delta-item.positive {
            color: var(--success);
        }

        .fix-delta-item.negative {
            color: var(--danger);
        }

        .fix-contrast-result {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-1);
        }

        .fix-contrast-chip {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .fix-contrast-chip.pass {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .fix-contrast-chip.fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .fix-warning {
            font-size: 11px;
            color: var(--warning);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fix-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-1);
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="header">
            <h1>üé® LCH Token Editor<span class="p3-badge" id="p3Badge">P3</span></h1>
            <div style="display:flex;gap:8px;align-items:center">
                <div style="display:flex;gap:4px;align-items:center">
                    <button class="btn btn-sm" id="undoBtn" onclick="undo()" title="Undo (‚åòZ)" disabled
                        style="display:flex;align-items:center;gap:3px;padding:5px 8px">
                        <i data-lucide="undo-2" style="width:14px;height:14px"></i>
                        <kbd style="font-size:10px;padding:2px 5px">Z</kbd>
                    </button>
                    <button class="btn btn-sm" id="redoBtn" onclick="redo()" title="Redo (‚åòY)" disabled
                        style="display:flex;align-items:center;gap:3px;padding:5px 8px">
                        <i data-lucide="redo-2" style="width:14px;height:14px"></i>
                        <kbd style="font-size:10px;padding:2px 5px">Y</kbd>
                    </button>
                    <button class="btn btn-sm" id="historyBtn" onclick="toggleHistoryPanel()" title="View history"
                        style="display:flex;align-items:center;gap:3px;padding:5px 8px">
                        <i data-lucide="history" style="width:14px;height:14px"></i>
                        <span id="historyCount" style="font-size:10px;min-width:12px">0</span>
                    </button>
                </div>
                <button class="btn" onclick="loadFile()" style="display:flex;align-items:center;gap:5px">
                    <i data-lucide="folder-open" style="width:14px;height:14px"></i> Load
                </button>
                <button class="btn btn-primary" onclick="showExport()" style="display:flex;align-items:center;gap:5px">
                    <i data-lucide="download" style="width:14px;height:14px"></i> Export
                </button>
            </div>
        </header>
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main" id="main"></main>
        <aside class="panel" id="panel"></aside>
    </div>
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Export</span><button class="modal-close"
                    onclick="closeExport()">√ó</button></div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <button class="modal-tab active" onclick="setTab('lch',this)">LCH JSON</button>
                    <button class="modal-tab" onclick="setTab('hex',this)">HEX JSON</button>
                    <button class="modal-tab" onclick="setTab('csslch',this)">CSS (LCH)</button>
                </div>
                <div class="export-code" id="exportCode"></div>
                <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-primary" onclick="copyCode()">Copy</button>
                    <button class="btn" onclick="downloadCode()">Download</button>
                    <button class="btn" onclick="saveToFile()" id="saveBtn" style="display:none">Save to
                        design-tokens</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="compareModal">
        <div class="modal compare-modal">
            <div class="modal-header">
                <span class="modal-title">Compare Palettes</span>
                <button class="modal-close" onclick="closeCompareModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="compare-tabs">
                    <button class="compare-tab active" onclick="setCompareView('visual',this)">Visual Compare</button>
                    <button class="compare-tab" onclick="setCompareView('changes',this)">Changes List</button>
                </div>
                <div id="compareContent"></div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="fixContrastModal">
        <div class="modal fix-modal">
            <div class="modal-header">
                <span class="modal-title">üîß Fix Contrast Issues</span>
                <button class="modal-close" onclick="closeFixModal()">√ó</button>
            </div>
            <div class="modal-body" id="fixModalContent"></div>
        </div>
    </div>
    <div class="modal-overlay" id="historyModal">
        <div class="modal" style="max-width:400px">
            <div class="modal-header">
                <span class="modal-title">‚è± History</span>
                <button class="modal-close" onclick="closeHistoryPanel()">√ó</button>
            </div>
            <div class="modal-body" id="historyContent" style="max-height:400px;overflow-y:auto"></div>
        </div>
    </div>
    <div id="toast" class="toast" style="display:none"></div>
    <input type="file" id="fileIn" accept=".json" style="display:none" onchange="handleFile(event)">
    <script>
        const SHADES = ['25', '50', '100', '150', '200', '300', '400', '500', '600', '700', '800', '850', '900', '950', '1000'];
        const FALLBACK_TOKENS = { "pure": { "white": { "$type": "color", "$value": "lch(100% 0 0)" }, "black": { "$type": "color", "$value": "lch(5% 1 286)" } }, "tuna": { "$type": "color", "25": { "$value": "lch(99% 0.3 284)" }, "50": { "$value": "lch(96% 1.5 284)" }, "100": { "$value": "lch(93% 3 284)" }, "150": { "$value": "lch(89% 5 284)" }, "200": { "$value": "lch(84% 7.5 284)" }, "300": { "$value": "lch(78% 10 283)" }, "400": { "$value": "lch(72% 12 283)" }, "500": { "$value": "lch(65% 13 283)" }, "600": { "$value": "lch(58% 12.5 283)" }, "700": { "$value": "lch(50% 11 283)" }, "800": { "$value": "lch(41% 9 283)" }, "850": { "$value": "lch(32% 7.5 283)" }, "900": { "$value": "lch(23% 6 283)" }, "950": { "$value": "lch(15% 4.5 283)" }, "1000": { "$value": "lch(8% 3 283)" } }, "chrome": { "$type": "color", "25": { "$value": "lch(99% 0 0)" }, "50": { "$value": "lch(96% 0.3 286)" }, "100": { "$value": "lch(93% 0.6 286)" }, "150": { "$value": "lch(89% 1 286)" }, "200": { "$value": "lch(84% 1.5 286)" }, "300": { "$value": "lch(78% 2.5 286)" }, "400": { "$value": "lch(72% 4 286)" }, "500": { "$value": "lch(65% 5 286)" }, "600": { "$value": "lch(58% 5.5 286)" }, "700": { "$value": "lch(50% 5 286)" }, "800": { "$value": "lch(41% 4 286)" }, "850": { "$value": "lch(32% 3.5 286)" }, "900": { "$value": "lch(23% 3 286)" }, "950": { "$value": "lch(15% 2.5 286)" }, "1000": { "$value": "lch(8% 2 286)" } }, "red": { "$type": "color", "25": { "$value": "lch(99% 4 22)" }, "50": { "$value": "lch(96% 12 22)" }, "100": { "$value": "lch(93% 22 24)" }, "150": { "$value": "lch(89% 35 26)" }, "200": { "$value": "lch(84% 52 28)" }, "300": { "$value": "lch(78% 70 30)" }, "400": { "$value": "lch(72% 82 31)" }, "500": { "$value": "lch(65% 88 32)" }, "600": { "$value": "lch(58% 85 32)" }, "700": { "$value": "lch(50% 78 32)" }, "800": { "$value": "lch(41% 65 31)" }, "850": { "$value": "lch(32% 48 29)" }, "900": { "$value": "lch(23% 32 27)" }, "950": { "$value": "lch(15% 20 25)" }, "1000": { "$value": "lch(8% 10 23)" } }, "orange": { "$type": "color", "25": { "$value": "lch(99% 5 70)" }, "50": { "$value": "lch(96% 18 68)" }, "100": { "$value": "lch(93% 35 65)" }, "150": { "$value": "lch(89% 55 62)" }, "200": { "$value": "lch(84% 78 58)" }, "300": { "$value": "lch(78% 95 55)" }, "400": { "$value": "lch(72% 105 53)" }, "500": { "$value": "lch(65% 100 52)" }, "600": { "$value": "lch(58% 88 52)" }, "700": { "$value": "lch(50% 72 52)" }, "800": { "$value": "lch(41% 55 51)" }, "850": { "$value": "lch(32% 40 49)" }, "900": { "$value": "lch(23% 28 46)" }, "950": { "$value": "lch(15% 18 43)" }, "1000": { "$value": "lch(8% 10 40)" } }, "yellow": { "$type": "color", "25": { "$value": "lch(99% 12 98)" }, "50": { "$value": "lch(96% 35 95)" }, "100": { "$value": "lch(93% 55 92)" }, "150": { "$value": "lch(89% 80 88)" }, "200": { "$value": "lch(84% 95 82)" }, "300": { "$value": "lch(78% 100 76)" }, "400": { "$value": "lch(72% 95 70)" }, "500": { "$value": "lch(65% 85 66)" }, "600": { "$value": "lch(58% 75 63)" }, "700": { "$value": "lch(50% 62 60)" }, "800": { "$value": "lch(41% 48 58)" }, "850": { "$value": "lch(32% 35 57)" }, "900": { "$value": "lch(23% 24 58)" }, "950": { "$value": "lch(15% 15 60)" }, "1000": { "$value": "lch(8% 8 62)" } }, "brown": { "$type": "color", "25": { "$value": "lch(99% 3 55)" }, "50": { "$value": "lch(96% 8 55)" }, "100": { "$value": "lch(93% 16 55)" }, "150": { "$value": "lch(89% 26 55)" }, "200": { "$value": "lch(84% 38 55)" }, "300": { "$value": "lch(78% 50 55)" }, "400": { "$value": "lch(72% 55 55)" }, "500": { "$value": "lch(65% 52 55)" }, "600": { "$value": "lch(58% 46 55)" }, "700": { "$value": "lch(50% 40 55)" }, "800": { "$value": "lch(41% 32 55)" }, "850": { "$value": "lch(32% 25 55)" }, "900": { "$value": "lch(23% 17 56)" }, "950": { "$value": "lch(15% 10 57)" }, "1000": { "$value": "lch(8% 5 58)" } }, "lime": { "$type": "color", "25": { "$value": "lch(99% 14 131)" }, "50": { "$value": "lch(96% 30 131)" }, "100": { "$value": "lch(93% 48 131)" }, "150": { "$value": "lch(89% 65 131)" }, "200": { "$value": "lch(84% 80 131)" }, "300": { "$value": "lch(78% 88 131)" }, "400": { "$value": "lch(72% 85 131)" }, "500": { "$value": "lch(65% 75 131)" }, "600": { "$value": "lch(58% 65 131)" }, "700": { "$value": "lch(50% 52 131)" }, "800": { "$value": "lch(41% 40 131)" }, "850": { "$value": "lch(32% 30 131)" }, "900": { "$value": "lch(23% 20 131)" }, "950": { "$value": "lch(15% 12 131)" }, "1000": { "$value": "lch(8% 7 130)" } }, "green": { "$type": "color", "25": { "$value": "lch(99% 6 167)" }, "50": { "$value": "lch(96% 16 167)" }, "100": { "$value": "lch(93% 28 167)" }, "150": { "$value": "lch(89% 42 167)" }, "200": { "$value": "lch(84% 55 166)" }, "300": { "$value": "lch(78% 65 166)" }, "400": { "$value": "lch(72% 68 166)" }, "500": { "$value": "lch(65% 62 167)" }, "600": { "$value": "lch(58% 55 167)" }, "700": { "$value": "lch(50% 46 167)" }, "800": { "$value": "lch(41% 36 167)" }, "850": { "$value": "lch(32% 26 167)" }, "900": { "$value": "lch(23% 17 167)" }, "950": { "$value": "lch(15% 10 167)" }, "1000": { "$value": "lch(8% 5 167)" } }, "mint": { "$type": "color", "25": { "$value": "lch(99% 5 177)" }, "50": { "$value": "lch(96% 14 177)" }, "100": { "$value": "lch(93% 24 177)" }, "150": { "$value": "lch(89% 36 177)" }, "200": { "$value": "lch(84% 48 177)" }, "300": { "$value": "lch(78% 55 177)" }, "400": { "$value": "lch(72% 55 177)" }, "500": { "$value": "lch(65% 50 177)" }, "600": { "$value": "lch(58% 44 177)" }, "700": { "$value": "lch(50% 38 177)" }, "800": { "$value": "lch(41% 30 177)" }, "850": { "$value": "lch(32% 22 178)" }, "900": { "$value": "lch(23% 15 180)" }, "950": { "$value": "lch(15% 9 185)" }, "1000": { "$value": "lch(8% 5 190)" } }, "cyan": { "$type": "color", "25": { "$value": "lch(99% 5 230)" }, "50": { "$value": "lch(96% 14 240)" }, "100": { "$value": "lch(93% 24 248)" }, "150": { "$value": "lch(89% 35 250)" }, "200": { "$value": "lch(84% 46 252)" }, "300": { "$value": "lch(78% 55 253)" }, "400": { "$value": "lch(72% 58 253)" }, "500": { "$value": "lch(65% 55 253)" }, "600": { "$value": "lch(58% 50 253)" }, "700": { "$value": "lch(50% 42 253)" }, "800": { "$value": "lch(41% 34 253)" }, "850": { "$value": "lch(32% 26 253)" }, "900": { "$value": "lch(23% 18 254)" }, "950": { "$value": "lch(15% 12 255)" }, "1000": { "$value": "lch(8% 7 256)" } }, "blue": { "$type": "color", "25": { "$value": "lch(99% 5 275)" }, "50": { "$value": "lch(96% 14 276)" }, "100": { "$value": "lch(93% 26 278)" }, "150": { "$value": "lch(89% 38 279)" }, "200": { "$value": "lch(84% 52 280)" }, "300": { "$value": "lch(78% 65 280)" }, "400": { "$value": "lch(72% 72 280)" }, "500": { "$value": "lch(65% 75 280)" }, "600": { "$value": "lch(58% 72 280)" }, "700": { "$value": "lch(50% 65 280)" }, "800": { "$value": "lch(41% 52 280)" }, "850": { "$value": "lch(32% 40 280)" }, "900": { "$value": "lch(23% 28 281)" }, "950": { "$value": "lch(15% 18 282)" }, "1000": { "$value": "lch(8% 10 282)" } }, "indigo": { "$type": "color", "25": { "$value": "lch(99% 4 275)" }, "50": { "$value": "lch(96% 12 278)" }, "100": { "$value": "lch(93% 24 280)" }, "150": { "$value": "lch(89% 36 283)" }, "200": { "$value": "lch(84% 50 285)" }, "300": { "$value": "lch(78% 65 287)" }, "400": { "$value": "lch(72% 75 289)" }, "500": { "$value": "lch(65% 82 290)" }, "600": { "$value": "lch(58% 85 291)" }, "700": { "$value": "lch(50% 78 291)" }, "800": { "$value": "lch(41% 65 291)" }, "850": { "$value": "lch(32% 50 290)" }, "900": { "$value": "lch(23% 35 289)" }, "950": { "$value": "lch(15% 22 289)" }, "1000": { "$value": "lch(8% 12 289)" } }, "violet": { "$type": "color", "25": { "$value": "lch(99% 4 296)" }, "50": { "$value": "lch(96% 14 296)" }, "100": { "$value": "lch(93% 28 296)" }, "150": { "$value": "lch(89% 42 297)" }, "200": { "$value": "lch(84% 58 298)" }, "300": { "$value": "lch(78% 72 299)" }, "400": { "$value": "lch(72% 82 299)" }, "500": { "$value": "lch(65% 88 300)" }, "600": { "$value": "lch(58% 88 300)" }, "700": { "$value": "lch(50% 82 300)" }, "800": { "$value": "lch(41% 68 300)" }, "850": { "$value": "lch(32% 52 300)" }, "900": { "$value": "lch(23% 36 299)" }, "950": { "$value": "lch(15% 22 298)" }, "1000": { "$value": "lch(8% 12 298)" } }, "purple": { "$type": "color", "25": { "$value": "lch(99% 5 312)" }, "50": { "$value": "lch(96% 16 312)" }, "100": { "$value": "lch(93% 32 312)" }, "150": { "$value": "lch(89% 48 312)" }, "200": { "$value": "lch(84% 65 312)" }, "300": { "$value": "lch(78% 82 312)" }, "400": { "$value": "lch(72% 92 312)" }, "500": { "$value": "lch(65% 95 312)" }, "600": { "$value": "lch(58% 92 313)" }, "700": { "$value": "lch(50% 82 313)" }, "800": { "$value": "lch(41% 65 313)" }, "850": { "$value": "lch(32% 48 313)" }, "900": { "$value": "lch(23% 32 313)" }, "950": { "$value": "lch(15% 20 312)" }, "1000": { "$value": "lch(8% 10 312)" } }, "pink": { "$type": "color", "25": { "$value": "lch(99% 4 340)" }, "50": { "$value": "lch(96% 14 338)" }, "100": { "$value": "lch(93% 28 337)" }, "150": { "$value": "lch(89% 45 336)" }, "200": { "$value": "lch(84% 62 336)" }, "300": { "$value": "lch(78% 78 336)" }, "400": { "$value": "lch(72% 88 337)" }, "500": { "$value": "lch(65% 90 338)" }, "600": { "$value": "lch(58% 85 338)" }, "700": { "$value": "lch(50% 75 338)" }, "800": { "$value": "lch(41% 60 338)" }, "850": { "$value": "lch(32% 45 336)" }, "900": { "$value": "lch(23% 30 334)" }, "950": { "$value": "lch(15% 18 332)" }, "1000": { "$value": "lch(8% 10 330)" } } };

        let state = {
            tokens: JSON.parse(JSON.stringify(FALLBACK_TOKENS)),
            oldTokens: null, // tokens from main branch (colors_lch.json)
            selFam: 'blue',
            selShade: '500',
            tab: 'lch',
            hasP3: false,
            compareMode: false,
            compareView: 'visual', // 'visual' or 'changes'
            showOnlyChanges: false,
            previewOld: false, // toggle to preview old/main version on main grid
            contrastTarget: null, // selected target shade for contrast fix (e.g., '25')
            hueMode: 'shade', // 'shade' = only this shade, 'all' = apply to all, 'shift' = shift family
            hideTuna: true, // hide tuna from old palette by default
            contrastFamily: 'gray' // family to check contrast against
        };

        // History for undo/redo
        const history = {
            stack: [],
            index: -1,
            maxSize: 50
        };

        function saveToHistory(action) {
            // Remove any redo states
            if (history.index < history.stack.length - 1) {
                history.stack = history.stack.slice(0, history.index + 1);
            }
            // Add new state
            history.stack.push({
                tokens: JSON.parse(JSON.stringify(state.tokens)),
                action: action,
                timestamp: Date.now()
            });
            // Limit history size
            if (history.stack.length > history.maxSize) {
                history.stack.shift();
            } else {
                history.index++;
            }
            updateHistoryUI();
        }

        function undo() {
            if (history.index > 0) {
                history.index--;
                state.tokens = JSON.parse(JSON.stringify(history.stack[history.index].tokens));
                render();
                broadcastColorChange();
                toast(`Undo: ${history.stack[history.index + 1].action}`);
            } else {
                toast('Nothing to undo');
            }
        }

        function redo() {
            if (history.index < history.stack.length - 1) {
                history.index++;
                state.tokens = JSON.parse(JSON.stringify(history.stack[history.index].tokens));
                render();
                broadcastColorChange();
                toast(`Redo: ${history.stack[history.index].action}`);
            } else {
                toast('Nothing to redo');
            }
        }

        function updateHistoryUI() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            const historyCount = document.getElementById('historyCount');
            if (undoBtn) undoBtn.disabled = history.index <= 0;
            if (redoBtn) redoBtn.disabled = history.index >= history.stack.length - 1;
            if (historyCount) historyCount.textContent = history.stack.length > 1 ? history.stack.length - 1 : '0';
        }

        // Initialize history with current state
        function initHistory() {
            history.stack = [{
                tokens: JSON.parse(JSON.stringify(state.tokens)),
                action: 'Initial state',
                timestamp: Date.now()
            }];
            history.index = 0;
            updateHistoryUI();
        }

        function toggleHistoryPanel() {
            const modal = document.getElementById('historyModal');
            if (modal.classList.contains('open')) {
                closeHistoryPanel();
            } else {
                modal.classList.add('open');
                renderHistoryContent();
            }
        }

        function closeHistoryPanel() {
            document.getElementById('historyModal').classList.remove('open');
        }

        function renderHistoryContent() {
            const container = document.getElementById('historyContent');
            if (history.stack.length <= 1) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:20px">No changes yet</div>';
                return;
            }

            let html = '<div style="display:flex;flex-direction:column;gap:4px">';
            // Show in reverse order (newest first)
            for (let i = history.stack.length - 1; i >= 0; i--) {
                const item = history.stack[i];
                const time = new Date(item.timestamp);
                const timeStr = time.toLocaleTimeString();
                const isCurrent = i === history.index;

                html += `
                    <div style="display:flex;align-items:center;gap:8px;padding:8px;background:${isCurrent ? 'var(--accent)' : 'var(--bg-2)'};border-radius:4px;cursor:pointer" onclick="restoreToHistory(${i})">
                        <span style="font-size:10px;color:${isCurrent ? '#000' : 'var(--text-3)'};min-width:60px">${timeStr}</span>
                        <span style="flex:1;font-size:11px;color:${isCurrent ? '#000' : 'var(--text-1)'}">${item.action}</span>
                        ${isCurrent ? '<span style="font-size:9px;color:#000">‚óè current</span>' : ''}
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function restoreToHistory(index) {
            if (index < 0 || index >= history.stack.length) return;
            history.index = index;
            state.tokens = JSON.parse(JSON.stringify(history.stack[index].tokens));
            render();
            broadcastColorChange();
            updateHistoryUI();
            renderHistoryContent();
            toast(`Restored: ${history.stack[index].action}`);
        }
        const { lch, rgb, formatHex, clampChroma, p3 } = culori;

        function checkP3() {
            state.hasP3 = window.matchMedia?.('(color-gamut:p3)').matches;
            document.getElementById('p3Badge').textContent = state.hasP3 ? 'P3 ‚úì' : 'sRGB fallback';
        }

        function parseLCH(s) {
            const m = s?.match(/lch\((\d+(?:\.\d+)?)%\s+(\d+(?:\.\d+)?)\s+(\d+(?:\.\d+)?)\)/);
            return m ? { mode: 'lch', l: +m[1], c: +m[2], h: +m[3] } : null;
        }

        function fmtLCH(l, c, h) {
            return `lch(${Math.round(l)}% ${Math.round(c * 10) / 10} ${Math.round(h)})`;
        }

        // Always render in P3 when available, only flag colors outside P3 gamut
        function getDisplay(lc) {
            if (!lc) return { css: '#888', hex: '#888', gamut: 'ok', rgb: null, p3: null };

            const p3c = p3(lc);
            const inP3 = p3c && p3c.r >= 0 && p3c.r <= 1 && p3c.g >= 0 && p3c.g <= 1 && p3c.b >= 0 && p3c.b <= 1;

            // For sRGB hex fallback (always needed for export/copy)
            const rgbClamped = rgb(clampChroma(lc, 'lch', 'rgb'));
            const hex = formatHex(rgbClamped);

            if (inP3) {
                // Color is within P3 gamut - render in P3 if display supports it
                const css = state.hasP3
                    ? `color(display-p3 ${p3c.r.toFixed(4)} ${p3c.g.toFixed(4)} ${p3c.b.toFixed(4)})`
                    : hex;
                return { css, hex, gamut: 'ok', rgb: rgbClamped, p3: p3c };
            } else {
                // Color is outside P3 - clamp to P3 and flag as out-of-gamut
                const clampedP3 = p3(clampChroma(lc, 'lch', 'p3'));
                const css = state.hasP3
                    ? `color(display-p3 ${clampedP3.r.toFixed(4)} ${clampedP3.g.toFixed(4)} ${clampedP3.b.toFixed(4)})`
                    : hex;
                return { css, hex, gamut: 'oog', rgb: rgbClamped, p3: clampedP3 };
            }
        }

        function getLum(c) {
            if (!c) return 0;
            const r = c.r <= .03928 ? c.r / 12.92 : Math.pow((c.r + .055) / 1.055, 2.4);
            const g = c.g <= .03928 ? c.g / 12.92 : Math.pow((c.g + .055) / 1.055, 2.4);
            const b = c.b <= .03928 ? c.b / 12.92 : Math.pow((c.b + .055) / 1.055, 2.4);
            return .2126 * r + .7152 * g + .0722 * b;
        }

        function getCR(c1, c2) {
            const l1 = getLum(c1), l2 = getLum(c2);
            return (Math.max(l1, l2) + .05) / (Math.min(l1, l2) + .05);
        }

        function txtCol(bg) {
            if (!bg) return '#fff';
            return getCR(bg, { r: 1, g: 1, b: 1 }) > getCR(bg, { r: 0, g: 0, b: 0 }) ? '#fff' : '#000';
        }

        function getFams() { return Object.keys(state.tokens).filter(k => k !== 'pure'); }
        function getVal(f, s) { return state.tokens[f]?.[s]?.$value || null; }
        function getOldVal(f, s) { return state.oldTokens?.[f]?.[s]?.$value || null; }
        function setVal(f, s, v) { if (state.tokens[f]?.[s]) state.tokens[f][s].$value = v; }
        function getHue(f) { const v = getVal(f, '500'), lc = parseLCH(v); return lc ? Math.round(lc.h) : 0; }

        // Compare two LCH values and return delta
        function getDelta(newVal, oldVal) {
            if (!oldVal) return { isNew: true };
            if (!newVal) return null;
            const newLch = parseLCH(newVal);
            const oldLch = parseLCH(oldVal);
            if (!newLch || !oldLch) return null;
            const dL = Math.round(newLch.l - oldLch.l);
            const dC = Math.round((newLch.c - oldLch.c) * 10) / 10;
            const dH = Math.round(newLch.h - oldLch.h);
            const hasChange = dL !== 0 || dC !== 0 || dH !== 0;
            return { dL, dC, dH, hasChange };
        }

        function renderSidebar() {
            const sb = document.getElementById('sidebar');

            // Calculate change stats
            let changedCount = 0, totalCount = 0;
            if (state.oldTokens) {
                getFams().forEach(f => {
                    SHADES.forEach(s => {
                        const newV = getVal(f, s);
                        const oldV = getOldVal(f, s);
                        if (newV) {
                            totalCount++;
                            const delta = getDelta(newV, oldV);
                            if (delta?.hasChange || delta?.isNew) changedCount++;
                        }
                    });
                });
            }

            sb.innerHTML = `
    ${state.oldTokens ? `
    <div class="compare-section">
      <div class="compare-tabs" style="margin-bottom:8px">
        <button class="compare-tab ${!state.previewOld ? 'active' : ''}" onclick="togglePreviewOld(false)">New</button>
        <button class="compare-tab ${state.previewOld ? 'active' : ''}" onclick="togglePreviewOld(true)">Current</button>
      </div>
      ${!state.previewOld ? `
      <button class="btn btn-sm ${state.compareMode ? 'btn-primary' : ''}" onclick="toggleCompare(!state.compareMode)" style="width:100%;font-size:10px;display:flex;align-items:center;justify-content:center;gap:6px">
        <i data-lucide="${state.compareMode ? 'eye' : 'eye-off'}" style="width:12px;height:12px"></i>
        ${state.compareMode ? `Comparing (${changedCount} changes)` : 'Show changes'}
      </button>` : `
      <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-3);cursor:pointer">
        <input type="checkbox" ${state.hideTuna ? 'checked' : ''} onchange="toggleHideTuna(this.checked)" style="accent-color:var(--accent)">
        Hide tuna
      </label>`}
    </div>` : ''}
    <div class="section">
      <div class="section-title">Families</div>
      ${(() => {
                    // Use display tokens based on preview mode
                    const displayTokens = state.previewOld && state.oldTokens ? state.oldTokens : state.tokens;
                    let families = Object.keys(displayTokens).filter(k => k !== 'pure');

                    // Hide tuna when viewing Main if hideTuna is enabled
                    if (state.previewOld && state.hideTuna) {
                        families = families.filter(f => f !== 'tuna');
                    }

                    return families.map(f => {
                        const displayVal = displayTokens[f]?.['500']?.$value;
                        const lc = parseLCH(displayVal), d = getDisplay(lc);
                        const hue = lc ? Math.round(lc.h) : '?';
                        // Count changes per family (only in New mode with compare on)
                        let famChanges = 0;
                        if (!state.previewOld && state.compareMode && state.oldTokens) {
                            SHADES.forEach(s => {
                                const delta = getDelta(getVal(f, s), getOldVal(f, s));
                                if (delta?.hasChange || delta?.isNew) famChanges++;
                            });
                        }
                        return `<div class="family-item ${state.selFam === f ? 'active' : ''}" onclick="sel('${f}')">
          <div class="family-swatch" style="background:${d.css}"></div>
          <span class="family-name">${f}</span>
          ${!state.previewOld && state.compareMode && famChanges > 0 ? `<span style="font-size:10px;color:var(--warning)">${famChanges}</span>` : `<span class="family-hue">H${hue}</span>`}
        </div>`;
                    }).join('');
                })()}
    </div>`;

            // Show/hide compare button in header
            const compareBtn = document.getElementById('compareBtn');
            if (compareBtn) compareBtn.style.display = state.oldTokens ? 'block' : 'none';
        }

        function renderMain() {
            const m = document.getElementById('main');
            // Get the tokens to display based on preview mode
            const displayTokens = state.previewOld && state.oldTokens ? state.oldTokens : state.tokens;
            const getDisplayVal = (f, s) => displayTokens[f]?.[s]?.$value || null;
            let displayFams = Object.keys(displayTokens).filter(k => k !== 'pure');

            // Hide tuna from old palette if hideTuna is enabled
            if (state.previewOld && state.hideTuna) {
                displayFams = displayFams.filter(f => f !== 'tuna');
            }

            m.innerHTML = `
    <div class="palette-header">${SHADES.map(s => `<span>${s}</span>`).join('')}</div>
    ${displayFams.map(f => `
      <div class="palette-row">
        <div class="palette-label">${f}</div>
        <div class="palette-shades">
          ${SHADES.map(s => {
                const v = getDisplayVal(f, s);
                if (!v) return '<div class="shade" style="opacity:.2"></div>';
                const lc = parseLCH(v), d = getDisplay(lc), tc = txtCol(d.rgb);
                const isSel = state.selFam === f && state.selShade === s;
                const gc = d.gamut === 'oog' ? 'oog' : '';

                // Compare mode diff indicator (only when viewing new)
                let diffHtml = '';
                if (!state.previewOld && state.compareMode && state.oldTokens) {
                    const oldV = getOldVal(f, s);
                    const delta = getDelta(v, oldV);
                    if (delta?.isNew) {
                        diffHtml = '<span class="shade-diff new">NEW</span>';
                    } else if (delta?.hasChange) {
                        diffHtml = `<span class="shade-diff changed">Œî</span>`;
                    }
                }

                return `<div class="shade ${gc} ${isSel ? 'selected' : ''}" 
                         style="background:${d.css};color:${tc}${state.previewOld ? ';cursor:default' : ''}" 
                         onclick="pick('${f}','${s}')">
              <span class="shade-l">${lc ? Math.round(lc.l) : '?'}</span>
              <span class="shade-c">${lc ? Math.round(lc.c) : ''}</span>
              ${diffHtml}
            </div>`;
            }).join('')}
        </div>
      </div>
    `).join('')}
    ${renderContrastRow()}`;
        }

        function renderContrastRow() {
            // Use display tokens based on preview mode
            const displayTokens = state.previewOld && state.oldTokens ? state.oldTokens : state.tokens;
            const getDisplayVal = (f, s) => displayTokens[f]?.[s]?.$value || null;

            const selV = getDisplayVal(state.selFam, state.selShade);
            if (!selV) return '';
            const selLc = parseLCH(selV), selD = getDisplay(selLc);
            if (!selD.rgb) return '';

            const contrastFam = state.contrastFamily || 'gray';
            const contrastTarget = state.contrastTarget;

            // Get target shade info if selected
            let targetInfo = null;
            let suggestion = null;

            if (contrastTarget && !state.previewOld) {
                const targetV = getDisplayVal(contrastFam, contrastTarget);
                if (targetV) {
                    const targetLc = parseLCH(targetV);
                    const targetD = getDisplay(targetLc);
                    const cr = getCR(selD.rgb, targetD.rgb);
                    targetInfo = { shade: contrastTarget, lch: targetLc, display: targetD, ratio: cr };

                    // Generate fix suggestion if doesn't pass AA
                    if (cr < 4.5) {
                        suggestion = generateQuickFix(selLc, targetD.rgb, targetLc.l, state.selFam, state.selShade);
                    }
                }
            }

            // Get color for current contrast family
            const contrastFamColor = getDisplayVal(contrastFam, '500');
            const contrastFamD = contrastFamColor ? getDisplay(parseLCH(contrastFamColor)) : { css: '#888' };

            return `
    <div class="contrast-row">
      <div class="contrast-row-header">
        <span>Contrast with</span>
        <div class="family-dropdown">
          <button class="family-dropdown-btn" onclick="toggleFamilyDropdown(event)">
            <span class="family-dropdown-swatch" style="background:${contrastFamD.css}"></span>
            <span>${contrastFam}</span>
            <span class="family-dropdown-arrow">‚ñæ</span>
          </button>
          <div class="family-dropdown-menu" id="familyDropdownMenu">
            ${Object.keys(displayTokens).filter(k => k !== 'pure').map(f => {
                const fColor = getDisplayVal(f, '500');
                const fD = fColor ? getDisplay(parseLCH(fColor)) : { css: '#888' };
                return `<div class="family-dropdown-item ${f === contrastFam ? 'active' : ''}" onclick="selectContrastFamily('${f}')">
                  <span class="family-dropdown-swatch" style="background:${fD.css}"></span>
                  <span>${f}</span>
                </div>`;
            }).join('')}
          </div>
        </div>
        <div class="contrast-row-selected" style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <div style="width:20px;height:20px;border-radius:4px;background:${selD.css}"></div>
          <span style="font-size:11px;color:var(--text-2)">${state.selFam}-${state.selShade}${state.previewOld ? ' (Main)' : ''}</span>
        </div>
      </div>
      <div class="contrast-row-shades">
        ${SHADES.map(s => {
                const v = getDisplayVal(contrastFam, s);
                if (!v) return '<div class="contrast-cell empty"></div>';
                const lc = parseLCH(v), d = getDisplay(lc);
                const cr = getCR(selD.rgb, d.rgb);
                const passes = { AAL: cr >= 3, AA: cr >= 4.5, AAA: cr >= 7 };
                const level = passes.AAA ? 'aaa' : passes.AA ? 'aa' : passes.AAL ? 'aal' : 'fail';
                const isTarget = contrastTarget === s;
                return `<div class="contrast-cell ${level} ${isTarget ? 'target' : ''}" onclick="selectContrastTarget('${s}')" title="Click to select ${contrastFam}-${s} as contrast target">
            <div class="contrast-cell-shade">${s}</div>
            <div class="contrast-cell-swatch" style="background:${d.css}"></div>
            <div class="contrast-cell-ratio">${cr.toFixed(1)}</div>
            <div class="contrast-cell-level">${passes.AAA ? 'AAA' : passes.AA ? 'AA' : passes.AAL ? 'AA-L' : '‚Äî'}</div>
          </div>`;
            }).join('')}
      </div>
      ${targetInfo ? renderTargetSuggestion(targetInfo, suggestion, selLc, selD, contrastFam) : `
      <div class="contrast-hint">
        <span>üëÜ Click a shade above to see fix suggestions for ${state.selFam}-${state.selShade}</span>
      </div>`}
    </div>`;
        }

        function selectContrastTarget(shade) {
            state.contrastTarget = state.contrastTarget === shade ? null : shade;
            render();
        }

        function toggleFamilyDropdown(e) {
            e.stopPropagation();
            const menu = document.getElementById('familyDropdownMenu');
            menu.classList.toggle('open');

            // Close on outside click
            if (menu.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', closeFamilyDropdown, { once: true });
                }, 0);
            }
        }

        function closeFamilyDropdown() {
            const menu = document.getElementById('familyDropdownMenu');
            if (menu) menu.classList.remove('open');
        }

        function selectContrastFamily(fam) {
            state.contrastFamily = fam;
            state.contrastTarget = null; // Reset target when changing family
            closeFamilyDropdown();
            render();
        }

        function getLightnessRange(fam, shade) {
            // Get the valid lightness range for a shade based on neighbors
            const shadeIdx = SHADES.indexOf(shade);
            let minL = 0, maxL = 100;

            // Get previous shade's lightness (should be higher)
            if (shadeIdx > 0) {
                const prevShade = SHADES[shadeIdx - 1];
                const prevV = getVal(fam, prevShade);
                if (prevV) {
                    const prevLc = parseLCH(prevV);
                    if (prevLc) maxL = prevLc.l - 1; // Must be at least 1 less than previous
                }
            }

            // Get next shade's lightness (should be lower)
            if (shadeIdx < SHADES.length - 1) {
                const nextShade = SHADES[shadeIdx + 1];
                const nextV = getVal(fam, nextShade);
                if (nextV) {
                    const nextLc = parseLCH(nextV);
                    if (nextLc) minL = nextLc.l + 1; // Must be at least 1 more than next
                }
            }

            return { minL, maxL };
        }

        function generateQuickFix(sourceLc, targetRgb, targetL, sourceFam, sourceShade) {
            const originalL = sourceLc.l;
            const originalC = sourceLc.c;
            const originalH = sourceLc.h;

            // Get valid lightness range to maintain palette progression
            const { minL, maxL } = getLightnessRange(sourceFam, sourceShade);

            // Determine direction: if target is lighter, we should go darker (and vice versa)
            const shouldGoDarker = targetL > 50;

            let bestFix = null;
            let gentleFix = null; // Fix within palette constraints

            // Try lightness adjustment
            for (let deltaL = 1; deltaL <= 40; deltaL++) {
                // Try preferred direction first
                const directions = shouldGoDarker ? [-deltaL, deltaL] : [deltaL, -deltaL];

                for (const dir of directions) {
                    const newL = Math.max(0, Math.min(100, originalL + dir));
                    const testLc = { mode: 'lch', l: newL, c: originalC, h: originalH };
                    const testD = getDisplay(testLc);
                    const cr = getCR(testD.rgb, targetRgb);

                    if (cr >= 4.5) {
                        const fix = {
                            lch: testLc,
                            display: testD,
                            delta: { l: dir, c: 0 },
                            ratio: cr,
                            withinRange: newL >= minL && newL <= maxL,
                            breaksProgression: newL < minL || newL > maxL
                        };

                        if (!bestFix) bestFix = fix;
                        if (fix.withinRange && !gentleFix) gentleFix = fix;

                        // If we found a gentle fix, we're done
                        if (gentleFix) break;
                    }
                }
                if (gentleFix) break;
            }

            // Prefer gentle fix, fall back to best fix
            const result = gentleFix || bestFix;
            if (result) {
                result.isGentle = !!gentleFix;
                result.minL = minL;
                result.maxL = maxL;
            }
            return result;
        }

        function renderTargetSuggestion(targetInfo, suggestion, originalLc, originalD, contrastFam) {
            const targetD = targetInfo.display;
            const targetTc = txtCol(targetD.rgb);
            const origTc = txtCol(originalD.rgb);
            const passesAA = targetInfo.ratio >= 4.5;

            if (passesAA) {
                return `
      <div class="suggestion-row pass">
        <div class="suggestion-preview">
          <div class="suggestion-pair">
            <div class="suggestion-swatch" style="background:${originalD.css};color:${origTc}">
              ${state.selFam}-${state.selShade}
            </div>
            <span class="suggestion-vs">+</span>
            <div class="suggestion-swatch" style="background:${targetD.css};color:${targetTc}">
              ${contrastFam}-${targetInfo.shade}
            </div>
          </div>
          <div class="suggestion-result pass">
            <span class="ratio">${targetInfo.ratio.toFixed(2)}:1</span>
            <span class="badge">‚úì AA</span>
          </div>
          <span style="color:var(--success);font-size:11px">This pair already passes WCAG AA!</span>
        </div>
      </div>`;
            }

            if (!suggestion) {
                return `
      <div class="suggestion-row fail">
        <div class="suggestion-preview">
          <div class="suggestion-pair">
            <div class="suggestion-swatch" style="background:${originalD.css};color:${origTc}">
              ${state.selFam}-${state.selShade}
            </div>
            <span class="suggestion-vs">+</span>
            <div class="suggestion-swatch" style="background:${targetD.css};color:${targetTc}">
              ${contrastFam}-${targetInfo.shade}
            </div>
          </div>
          <div class="suggestion-result fail">
            <span class="ratio">${targetInfo.ratio.toFixed(2)}:1</span>
            <span class="badge">‚úó Fail</span>
          </div>
          <span style="color:var(--danger);font-size:11px">Cannot fix with lightness adjustment alone</span>
        </div>
      </div>`;
            }

            const sugD = suggestion.display;
            const sugTc = txtCol(sugD.rgb);
            const isGentle = suggestion.isGentle;

            return `
      <div class="suggestion-row ${isGentle ? 'gentle' : 'warning'}">
        <div class="suggestion-preview">
          <div class="suggestion-pair">
            <div class="suggestion-swatch current" style="background:${originalD.css};color:${origTc}">
              L:${Math.round(originalLc.l)}
            </div>
            <span class="suggestion-vs">‚Üí</span>
            <div class="suggestion-swatch fixed" style="background:${sugD.css};color:${sugTc}">
              L:${Math.round(suggestion.lch.l)}
            </div>
          </div>
          <div class="suggestion-delta ${suggestion.delta.l > 0 ? 'positive' : 'negative'}">
            ${suggestion.delta.l > 0 ? '+' : ''}${suggestion.delta.l}
          </div>
          <div class="suggestion-result-inline pass">
            ${suggestion.ratio.toFixed(1)}:1 AA
          </div>
          <button class="btn btn-sm btn-primary" onclick="applyQuickFix(${suggestion.lch.l}, ${suggestion.lch.c}, ${suggestion.lch.h})">
            Apply
          </button>
          ${!isGentle ? '<span class="suggestion-warn">‚ö† breaks progression</span>' : ''}
        </div>
      </div>`;
        }

        function applyQuickFix(l, c, h) {
            setVal(state.selFam, state.selShade, fmtLCH(l, c, h));
            render();
            broadcastColorChange();
            toast(`Applied fix to ${state.selFam}-${state.selShade}`);
        }

        function renderPanel() {
            const p = document.getElementById('panel');

            // Use old or new tokens based on preview mode
            const displayTokens = state.previewOld && state.oldTokens ? state.oldTokens : state.tokens;
            const getDisplayVal = (f, s) => displayTokens[f]?.[s]?.$value || null;

            const v = getDisplayVal(state.selFam, state.selShade);
            if (!v) { p.innerHTML = '<div style="padding:20px;color:var(--text-3)">Select shade</div>'; return; }

            const lc = parseLCH(v), d = getDisplay(lc), tc = txtCol(d.rgb);
            const isReadOnly = state.previewOld;

            // Get pure white and black from display tokens
            const pureWhiteV = displayTokens.pure?.white?.$value;
            const pureBlackV = displayTokens.pure?.black?.$value;
            const pureWhiteLc = parseLCH(pureWhiteV);
            const pureBlackLc = parseLCH(pureBlackV);
            const w = pureWhiteLc ? getDisplay(pureWhiteLc).rgb : { r: 1, g: 1, b: 1 };
            const b = pureBlackLc ? getDisplay(pureBlackLc).rgb : { r: 0, g: 0, b: 0 };

            const cw = getCR(d.rgb, w), cb = getCR(d.rgb, b);
            const ww = { AAL: cw >= 3, AA: cw >= 4.5, AAA: cw >= 7 };
            const wb = { AAL: cb >= 3, AA: cb >= 4.5, AAA: cb >= 7 };

            // Compare preview section
            let compareHtml = '';
            if (state.compareMode && state.oldTokens) {
                const oldV = getOldVal(state.selFam, state.selShade);
                const delta = getDelta(v, oldV);
                if (oldV) {
                    const oldLc = parseLCH(oldV);
                    const oldD = getDisplay(oldLc);
                    const oldTc = txtCol(oldD.rgb);
                    compareHtml = `
    <div class="compare-preview">
      <div class="compare-preview-item" style="background:${oldD.css};color:${oldTc}">
        <div class="compare-preview-label">Main</div>
        <div class="compare-preview-value">${oldV}</div>
      </div>
      <div class="compare-preview-item" style="background:${d.css};color:${tc}">
        <div class="compare-preview-label">New</div>
        <div class="compare-preview-value">${v}</div>
      </div>
    </div>
    ${delta?.hasChange ? `
    <div class="section">
      <div class="section-title">Changes from Main</div>
      <div class="delta-row">
        <span class="delta-label">ŒîL</span>
        <span class="delta-value ${delta.dL > 0 ? 'positive' : delta.dL < 0 ? 'negative' : 'neutral'}">${delta.dL > 0 ? '+' : ''}${delta.dL}</span>
      </div>
      <div class="delta-row">
        <span class="delta-label">ŒîC</span>
        <span class="delta-value ${delta.dC > 0 ? 'positive' : delta.dC < 0 ? 'negative' : 'neutral'}">${delta.dC > 0 ? '+' : ''}${delta.dC}</span>
      </div>
      <div class="delta-row">
        <span class="delta-label">ŒîH</span>
        <span class="delta-value ${delta.dH > 0 ? 'positive' : delta.dH < 0 ? 'negative' : 'neutral'}">${delta.dH > 0 ? '+' : ''}${delta.dH}¬∞</span>
      </div>
    </div>` : '<div style="padding:8px 0;color:var(--text-3);font-size:12px">No changes from main</div>'}`;
                } else {
                    compareHtml = '<div style="padding:8px 0;color:var(--success);font-size:12px">‚úì New color (not in main)</div>';
                }
            }

            p.innerHTML = `
    ${!isReadOnly ? compareHtml : ''}
    <div class="color-preview" style="background:${d.css};color:${tc}">
      ${state.selFam}-${state.selShade}${isReadOnly ? ' <span style="font-size:10px;opacity:0.7">(Main)</span>' : ''}
      <span class="gamut-tag ${d.gamut}">${d.gamut === 'ok' ? '‚úì P3' : '! OOG'}</span>
    </div>
    <div class="section">
      <div class="section-title">LCH${isReadOnly ? ' <span style="font-size:9px;color:var(--text-3)">(read-only)</span>' : ''}</div>
      ${isReadOnly ? `
      <div class="values-grid">
        <div class="value-item"><span class="value-label">L</span><span class="value-data">${lc?.l || 0}</span></div>
        <div class="value-item"><span class="value-label">C</span><span class="value-data">${lc?.c || 0}</span></div>
        <div class="value-item"><span class="value-label">H</span><span class="value-data">${lc?.h || 0}</span></div>
      </div>
      ` : `
      <div class="form-group">
        <label class="form-label">L (Lightness)</label>
        <div class="form-row">
          <input type="range" class="slider" min="0" max="100" value="${lc?.l || 50}" oninput="updL(this.value)">
          <input type="number" class="form-input form-input-sm" value="${lc?.l || 50}" onchange="updL(this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">C (Chroma)</label>
        <div class="form-row">
          <input type="range" class="slider" min="0" max="150" step="0.5" value="${lc?.c || 50}" oninput="updC(this.value)">
          <input type="number" class="form-input form-input-sm" value="${lc?.c || 50}" onchange="updC(this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">H (Hue)</label>
        <div class="form-row">
          <input type="range" class="slider" min="0" max="360" value="${lc?.h || 0}" oninput="updH(this.value)">
          <input type="number" class="form-input form-input-sm" value="${lc?.h || 0}" onchange="updH(this.value)">
        </div>
        <div style="display:flex;gap:2px;margin-top:6px">
          <button class="btn btn-sm ${state.hueMode === 'shade' ? 'btn-primary' : ''}" onclick="setHueMode('shade')" style="flex:1;padding:3px 6px;font-size:9px" title="Change only this shade (1)">Shade <kbd>1</kbd></button>
          <button class="btn btn-sm ${state.hueMode === 'all' ? 'btn-primary' : ''}" onclick="setHueMode('all')" style="flex:1;padding:3px 6px;font-size:9px" title="Apply to all shades (2)">All <kbd>2</kbd></button>
          <button class="btn btn-sm ${state.hueMode === 'shift' ? 'btn-primary' : ''}" onclick="setHueMode('shift')" style="flex:1;padding:3px 6px;font-size:9px" title="Shift family harmonically (3)">Shift <kbd>3</kbd></button>
        </div>
      </div>
      `}
    </div>
    <div class="section">
      <div class="section-title">Output</div>
      <div style="display:flex;flex-direction:column;gap:4px;font-size:11px;font-family:monospace">
        <div style="display:flex;gap:8px">
          <span style="color:var(--text-3);min-width:28px">LCH</span>
          <span style="color:var(--text-1)">lch(${lc?.l || 0}% ${lc?.c || 0} ${lc?.h || 0})</span>
        </div>
        <div style="display:flex;gap:8px">
          <span style="color:var(--text-3);min-width:28px">Hex</span>
          <span style="color:var(--text-2)">${d.hex}</span>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Contrast</div>
      <div class="contrast-grid">
        <div class="contrast-card">
          <div class="contrast-card-header">
            <div class="contrast-swatch" style="background:${pureWhiteLc ? getDisplay(pureWhiteLc).css : '#fff'}"></div>
            <div class="contrast-card-info">
              <div class="contrast-title">pure.white</div>
              <div class="contrast-lch">${pureWhiteV || 'lch(100% 0 0)'}</div>
            </div>
          </div>
          <div class="contrast-ratio">${cw.toFixed(2)}:1</div>
          <div class="contrast-badges">
            <span class="badge ${ww.AAL ? 'pass' : 'fail'}">AA-L</span>
            <span class="badge ${ww.AA ? 'pass' : 'fail'}">AA</span>
            <span class="badge ${ww.AAA ? 'pass' : 'fail'}">AAA</span>
          </div>
        </div>
        <div class="contrast-card">
          <div class="contrast-card-header">
            <div class="contrast-swatch" style="background:${pureBlackLc ? getDisplay(pureBlackLc).css : '#000'}"></div>
            <div class="contrast-card-info">
              <div class="contrast-title">pure.black</div>
              <div class="contrast-lch">${pureBlackV || 'lch(0% 0 0)'}</div>
            </div>
          </div>
          <div class="contrast-ratio">${cb.toFixed(2)}:1</div>
          <div class="contrast-badges">
            <span class="badge ${wb.AAL ? 'pass' : 'fail'}">AA-L</span>
            <span class="badge ${wb.AA ? 'pass' : 'fail'}">AA</span>
            <span class="badge ${wb.AAA ? 'pass' : 'fail'}">AAA</span>
          </div>
        </div>
    </div>
`;
        }

        function updateContrastFamily(fam) {
            state.contrastFamily = fam;
            render();
        }

        function applyHueToFamily(hue) {
            const fam = state.selFam;
            if (!state.tokens[fam]) return;

            saveToHistory(`Set H:${Math.round(hue)} to ${fam}`);

            let count = 0;
            SHADES.forEach(s => {
                const v = getVal(fam, s);
                if (!v) return;
                const lc = parseLCH(v);
                if (!lc) return;
                lc.h = +hue;
                setVal(fam, s, fmtLCH(lc.l, lc.c, lc.h));
                count++;
            });

            render();
            broadcastColorChange();
            toast(`Set H:${Math.round(hue)} to ${count} shades in ${fam}`);
        }

        function shiftHueHarmonically() {
            const fam = state.selFam;
            const shade = state.selShade;
            if (!state.tokens[fam]) return;

            // Get the selected shade's current hue (after user edited it)
            const currentV = getVal(fam, shade);
            if (!currentV) return;
            const currentLc = parseLCH(currentV);
            if (!currentLc) return;
            const editedHue = currentLc.h;

            // Calculate average hue from OTHER shades (not the edited one)
            let hueSum = 0, hueCount = 0;
            SHADES.forEach(s => {
                if (s === shade) return; // Skip the edited shade
                const v = getVal(fam, s);
                if (!v) return;
                const lc = parseLCH(v);
                if (lc) {
                    hueSum += lc.h;
                    hueCount++;
                }
            });

            if (hueCount === 0) {
                toast('No other shades to shift');
                return;
            }

            const avgHue = hueSum / hueCount;
            let delta = editedHue - avgHue;

            // Normalize delta to -180 to 180 range
            while (delta > 180) delta -= 360;
            while (delta < -180) delta += 360;

            if (Math.abs(delta) < 0.5) {
                toast('No hue change detected');
                return;
            }

            saveToHistory(`Shift ${fam} by ${delta > 0 ? '+' : ''}${Math.round(delta)}¬∞`);

            // Apply delta to ALL shades
            let count = 0;
            SHADES.forEach(s => {
                const v = getVal(fam, s);
                if (!v) return;
                const lc = parseLCH(v);
                if (!lc) return;

                let newHue = lc.h + delta;
                while (newHue < 0) newHue += 360;
                while (newHue >= 360) newHue -= 360;

                lc.h = newHue;
                setVal(fam, s, fmtLCH(lc.l, lc.c, lc.h));
                count++;
            });

            render();
            broadcastColorChange();
            toast(`Shifted ${count} shades by ${delta > 0 ? '+' : ''}${Math.round(delta)}¬∞ in ${fam}`);
        }

        // ============ CONTRAST FIX FEATURE ============

        function showFixContrastModal() {
            document.getElementById('fixContrastModal').classList.add('open');
            renderFixModalContent();
        }

        function closeFixModal() {
            document.getElementById('fixContrastModal').classList.remove('open');
        }

        function analyzeContrastProblems(sourceFam, sourceShade, targetFam) {
            const sourceV = getVal(sourceFam, sourceShade);
            if (!sourceV) return { source: null, problems: [], allPass: true };

            const sourceLc = parseLCH(sourceV);
            const sourceD = getDisplay(sourceLc);

            const problems = [];
            SHADES.forEach(s => {
                const targetV = getVal(targetFam, s);
                if (!targetV) return;
                const targetLc = parseLCH(targetV);
                const targetD = getDisplay(targetLc);
                const cr = getCR(sourceD.rgb, targetD.rgb);
                if (cr < 4.5) { // Below AA
                    problems.push({
                        shade: s,
                        value: targetV,
                        lch: targetLc,
                        display: targetD,
                        ratio: cr,
                        needed: 4.5 - cr
                    });
                }
            });

            return {
                source: { fam: sourceFam, shade: sourceShade, value: sourceV, lch: sourceLc, display: sourceD },
                targetFam,
                problems,
                allPass: problems.length === 0
            };
        }

        function generateContrastSuggestions(sourceLc, targetRgb, targetRatio) {
            const suggestions = [];
            const originalL = sourceLc.l;
            const originalC = sourceLc.c;
            const originalH = sourceLc.h;

            // Strategy 1: Adjust Lightness only (most common, preserves hue)
            for (let deltaL = -30; deltaL <= 30; deltaL += 1) {
                const testLc = { mode: 'lch', l: Math.max(0, Math.min(100, originalL + deltaL)), c: originalC, h: originalH };
                const testD = getDisplay(testLc);
                const cr = getCR(testD.rgb, targetRgb);
                if (cr >= 4.5 && Math.abs(deltaL) > 0) {
                    suggestions.push({
                        type: 'lightness',
                        title: `Adjust Lightness ${deltaL > 0 ? '+' : ''}${deltaL}`,
                        description: 'Safest change - preserves color character',
                        lch: testLc,
                        display: testD,
                        delta: { l: deltaL, c: 0, h: 0 },
                        ratio: cr,
                        risk: 'low',
                        recommended: Math.abs(deltaL) <= 10
                    });
                    break; // Found minimal lightness change
                }
            }

            // Strategy 2: Reduce Chroma (makes color less saturated but keeps hue)
            for (let deltaC = -1; deltaC >= -originalC; deltaC -= 1) {
                const testLc = { mode: 'lch', l: originalL, c: Math.max(0, originalC + deltaC), h: originalH };
                const testD = getDisplay(testLc);
                const cr = getCR(testD.rgb, targetRgb);
                if (cr >= 4.5) {
                    suggestions.push({
                        type: 'chroma',
                        title: `Reduce Chroma ${deltaC}`,
                        description: 'Desaturates color slightly',
                        lch: testLc,
                        display: testD,
                        delta: { l: 0, c: deltaC, h: 0 },
                        ratio: cr,
                        risk: 'medium',
                        recommended: false
                    });
                    break;
                }
            }

            // Strategy 3: Combined L+C adjustment (smallest visual change)
            let bestCombined = null;
            for (let deltaL = -20; deltaL <= 20; deltaL += 2) {
                for (let deltaC = -10; deltaC <= 5; deltaC += 1) {
                    const testLc = {
                        mode: 'lch',
                        l: Math.max(0, Math.min(100, originalL + deltaL)),
                        c: Math.max(0, originalC + deltaC),
                        h: originalH
                    };
                    const testD = getDisplay(testLc);
                    const cr = getCR(testD.rgb, targetRgb);
                    if (cr >= 4.5) {
                        const totalChange = Math.abs(deltaL) + Math.abs(deltaC) * 2;
                        if (!bestCombined || totalChange < bestCombined.totalChange) {
                            bestCombined = {
                                type: 'combined',
                                title: `L${deltaL > 0 ? '+' : ''}${deltaL}, C${deltaC > 0 ? '+' : ''}${deltaC}`,
                                description: 'Balanced adjustment',
                                lch: testLc,
                                display: testD,
                                delta: { l: deltaL, c: deltaC, h: 0 },
                                ratio: cr,
                                risk: 'low',
                                recommended: totalChange <= 12,
                                totalChange
                            };
                        }
                    }
                }
            }
            if (bestCombined) suggestions.push(bestCombined);

            // Sort by recommended first, then by smallest change
            suggestions.sort((a, b) => {
                if (a.recommended && !b.recommended) return -1;
                if (!a.recommended && b.recommended) return 1;
                return (Math.abs(a.delta.l) + Math.abs(a.delta.c)) - (Math.abs(b.delta.l) + Math.abs(b.delta.c));
            });

            return suggestions.slice(0, 3); // Return top 3
        }

        function checkPaletteFit(fam, shade, newLc) {
            const warnings = [];
            const shadeIdx = SHADES.indexOf(shade);

            // Check lightness progression
            if (shadeIdx > 0) {
                const prevShade = SHADES[shadeIdx - 1];
                const prevV = getVal(fam, prevShade);
                if (prevV) {
                    const prevLc = parseLCH(prevV);
                    if (prevLc && newLc.l >= prevLc.l) {
                        warnings.push(`Lightness would be >= ${prevShade} shade (breaks progression)`);
                    }
                }
            }
            if (shadeIdx < SHADES.length - 1) {
                const nextShade = SHADES[shadeIdx + 1];
                const nextV = getVal(fam, nextShade);
                if (nextV) {
                    const nextLc = parseLCH(nextV);
                    if (nextLc && newLc.l <= nextLc.l) {
                        warnings.push(`Lightness would be <= ${nextShade} shade (breaks progression)`);
                    }
                }
            }

            // Check if chroma is too different from neighbors
            const avgChroma = SHADES.reduce((sum, s) => {
                const v = getVal(fam, s);
                if (!v || s === shade) return sum;
                const lc = parseLCH(v);
                return sum + (lc ? lc.c : 0);
            }, 0) / (SHADES.length - 1);

            if (Math.abs(newLc.c - avgChroma) > avgChroma * 0.5) {
                warnings.push('Chroma differs significantly from family average');
            }

            return warnings;
        }

        function renderFixModalContent() {
            const content = document.getElementById('fixModalContent');
            const analysis = analyzeContrastProblems(state.selFam, state.selShade, state.contrastFamily);

            if (!analysis.source) {
                content.innerHTML = '<div style="padding:20px;color:var(--text-3)">Select a shade first</div>';
                return;
            }

            const sourceD = analysis.source.display;
            const sourceTc = txtCol(sourceD.rgb);

            if (analysis.allPass) {
                content.innerHTML = `
                    <div class="fix-header">
                        <div class="fix-source">
                            <div class="fix-swatch" style="background:${sourceD.css}"></div>
                            <div class="fix-info">
                                <div class="fix-name">${analysis.source.fam}-${analysis.source.shade}</div>
                                <div class="fix-lch">${analysis.source.value}</div>
                            </div>
                        </div>
                        <div class="fix-arrow">‚Üí</div>
                        <div class="fix-target">
                            <div class="fix-info">
                                <div class="fix-name">${analysis.targetFam} family</div>
                                <div class="fix-lch">All shades</div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center;padding:40px;color:var(--success)">
                        <div style="font-size:32px;margin-bottom:12px">‚úì</div>
                        <div style="font-size:14px;font-weight:600">All shades pass AA contrast!</div>
                        <div style="font-size:12px;color:var(--text-3);margin-top:8px">No adjustments needed</div>
                    </div>
                `;
                return;
            }

            // Find the worst problem to generate suggestions for
            const worstProblem = analysis.problems.reduce((worst, p) =>
                !worst || p.ratio < worst.ratio ? p : worst, null);

            const suggestions = generateContrastSuggestions(
                analysis.source.lch,
                worstProblem.display.rgb,
                worstProblem.ratio
            );

            content.innerHTML = `
                <div class="fix-header">
                    <div class="fix-source">
                        <div class="fix-swatch" style="background:${sourceD.css}"></div>
                        <div class="fix-info">
                            <div class="fix-name">${analysis.source.fam}-${analysis.source.shade}</div>
                            <div class="fix-lch">${analysis.source.value}</div>
                        </div>
                    </div>
                    <div class="fix-arrow">vs</div>
                    <div class="fix-target">
                        <div class="fix-info">
                            <div class="fix-name">${analysis.targetFam} family</div>
                            <div class="fix-lch">${analysis.problems.length} shades fail AA</div>
                        </div>
                    </div>
                </div>
                
                <div class="fix-problems">
                    <div style="font-size:12px;color:var(--text-2);margin-bottom:8px;font-weight:600">Failing Shades:</div>
                    ${analysis.problems.map(p => `
                        <div class="fix-problem-row">
                            <div class="fix-problem-swatch" style="background:${p.display.css}"></div>
                            <div class="fix-problem-info">
                                <div class="fix-problem-name">${analysis.targetFam}-${p.shade}</div>
                                <div class="fix-problem-ratio">${p.ratio.toFixed(2)}:1 (need 4.5:1)</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="font-size:12px;color:var(--text-2);margin-bottom:12px;font-weight:600">
                    Suggested Adjustments for ${analysis.source.fam}-${analysis.source.shade}:
                </div>
                
                <div class="fix-suggestions">
                    ${suggestions.map((s, i) => {
                const warnings = checkPaletteFit(analysis.source.fam, analysis.source.shade, s.lch);
                const newContrastResults = analysis.problems.map(p => {
                    const cr = getCR(s.display.rgb, p.display.rgb);
                    return { shade: p.shade, ratio: cr, pass: cr >= 4.5 };
                });
                const allFixed = newContrastResults.every(r => r.pass);

                return `
                        <div class="fix-suggestion" onclick="selectFixSuggestion(${i})">
                            <div class="fix-suggestion-header">
                                <div class="fix-suggestion-title">${s.title}</div>
                                ${s.recommended ? '<span class="fix-suggestion-badge recommended">Recommended</span>' :
                        '<span class="fix-suggestion-badge alternative">Alternative</span>'}
                            </div>
                            <div style="font-size:11px;color:var(--text-3);margin-bottom:12px">${s.description}</div>
                            <div class="fix-suggestion-preview">
                                <div class="fix-before-after">
                                    <div class="fix-ba-label">Before</div>
                                    <div class="fix-ba-swatch" style="background:${sourceD.css};color:${sourceTc}">
                                        L:${Math.round(analysis.source.lch.l)} C:${Math.round(analysis.source.lch.c)}
                                    </div>
                                </div>
                                <div class="fix-before-after">
                                    <div class="fix-ba-label">After</div>
                                    <div class="fix-ba-swatch" style="background:${s.display.css};color:${txtCol(s.display.rgb)}">
                                        L:${Math.round(s.lch.l)} C:${Math.round(s.lch.c)}
                                    </div>
                                </div>
                            </div>
                            <div class="fix-delta">
                                ${s.delta.l !== 0 ? `<span class="fix-delta-item ${s.delta.l > 0 ? 'positive' : 'negative'}">ŒîL: ${s.delta.l > 0 ? '+' : ''}${s.delta.l}</span>` : ''}
                                ${s.delta.c !== 0 ? `<span class="fix-delta-item ${s.delta.c > 0 ? 'positive' : 'negative'}">ŒîC: ${s.delta.c > 0 ? '+' : ''}${s.delta.c}</span>` : ''}
                            </div>
                            <div class="fix-contrast-result">
                                ${newContrastResults.map(r => `
                                    <span class="fix-contrast-chip ${r.pass ? 'pass' : 'fail'}">
                                        ${analysis.targetFam}-${r.shade}: ${r.ratio.toFixed(1)}:1
                                    </span>
                                `).join('')}
                            </div>
                            ${warnings.length > 0 ? `
                                <div class="fix-warning">
                                    ‚ö†Ô∏è ${warnings.join(', ')}
                                </div>
                            ` : ''}
                            <div class="fix-actions">
                                <button class="btn btn-sm btn-primary" onclick="applyFixSuggestion('${analysis.source.fam}', '${analysis.source.shade}', ${s.lch.l}, ${s.lch.c}, ${s.lch.h}); event.stopPropagation();">
                                    Apply This Fix
                                </button>
                                ${!allFixed ? '<span style="font-size:10px;color:var(--warning);margin-left:8px">Some shades still fail</span>' : '<span style="font-size:10px;color:var(--success);margin-left:8px">‚úì Fixes all failing shades</span>'}
                            </div>
                        </div>
                    `;
            }).join('')}
                </div>
            `;
        }

        function selectFixSuggestion(index) {
            document.querySelectorAll('.fix-suggestion').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
        }

        function applyFixSuggestion(fam, shade, l, c, h) {
            setVal(fam, shade, fmtLCH(l, c, h));
            render();
            broadcastColorChange();
            renderFixModalContent(); // Refresh modal to show updated state
            toast(`Applied fix to ${fam}-${shade}`);
        }

        // Family mapping between New and Main palettes
        const familyMapping = {
            // New -> Main
            'gray': 'chrome',
            // Main -> New  
            'chrome': 'gray',
            'tuna': 'gray'
        };

        function mapFamilyForMode(family, toOld) {
            const displayTokens = toOld && state.oldTokens ? state.oldTokens : state.tokens;
            // If family exists in target tokens, keep it
            if (displayTokens[family]) return family;
            // Otherwise try mapping
            const mapped = familyMapping[family];
            if (mapped && displayTokens[mapped]) return mapped;
            // Fallback to first available family
            const families = Object.keys(displayTokens).filter(k => k !== 'pure');
            return families[0] || family;
        }

        function render() { renderSidebar(); renderMain(); renderPanel(); lucide.createIcons(); }
        function sel(f) { state.selFam = f; lastFamilyHue = null; render(); }
        function pick(f, s) { state.selFam = f; state.selShade = s; lastFamilyHue = null; render(); }
        function toggleCompare(enabled) { state.compareMode = enabled; render(); }
        function togglePreviewOld(showOld) {
            // Map selected family and contrast family when switching modes
            state.selFam = mapFamilyForMode(state.selFam, showOld);
            state.contrastFamily = mapFamilyForMode(state.contrastFamily, showOld);
            state.previewOld = showOld;
            render();
        }
        function toggleHideTuna(hide) { state.hideTuna = hide; render(); }
        function setHueMode(mode) { state.hueMode = mode; render(); }

        let historyDebounce = null;
        let lastFamilyHue = null; // Track family hue for shift mode

        function saveHistoryDebounced(action) {
            clearTimeout(historyDebounce);
            historyDebounce = setTimeout(() => saveToHistory(action), 500);
        }

        function updL(v) {
            const val = getVal(state.selFam, state.selShade), lc = parseLCH(val);
            if (!lc) return;
            lc.l = +v;
            setVal(state.selFam, state.selShade, fmtLCH(lc.l, lc.c, lc.h));
            render();
            broadcastColorChange();
            saveHistoryDebounced(`L:${v} on ${state.selFam}-${state.selShade}`);
        }

        function updC(v) {
            const val = getVal(state.selFam, state.selShade), lc = parseLCH(val);
            if (!lc) return;
            lc.c = +v;
            setVal(state.selFam, state.selShade, fmtLCH(lc.l, lc.c, lc.h));
            render();
            broadcastColorChange();
            saveHistoryDebounced(`C:${v} on ${state.selFam}-${state.selShade}`);
        }

        function updH(v) {
            const fam = state.selFam;
            const newHue = +v;

            if (state.hueMode === 'shade') {
                // Only change this shade
                const val = getVal(fam, state.selShade), lc = parseLCH(val);
                if (!lc) return;
                lc.h = newHue;
                setVal(fam, state.selShade, fmtLCH(lc.l, lc.c, lc.h));
                saveHistoryDebounced(`H:${Math.round(newHue)} on ${fam}-${state.selShade}`);
            } else if (state.hueMode === 'all') {
                // Apply same hue to all shades
                SHADES.forEach(s => {
                    const val = getVal(fam, s);
                    if (!val) return;
                    const lc = parseLCH(val);
                    if (!lc) return;
                    lc.h = newHue;
                    setVal(fam, s, fmtLCH(lc.l, lc.c, lc.h));
                });
                saveHistoryDebounced(`H:${Math.round(newHue)} to all ${fam}`);
            } else if (state.hueMode === 'shift') {
                // Shift all shades by delta
                // Calculate average hue of family (excluding current shade)
                if (lastFamilyHue === null) {
                    let hueSum = 0, count = 0;
                    SHADES.forEach(s => {
                        const val = getVal(fam, s);
                        if (!val) return;
                        const lc = parseLCH(val);
                        if (lc) { hueSum += lc.h; count++; }
                    });
                    lastFamilyHue = count > 0 ? hueSum / count : newHue;
                }

                const delta = newHue - lastFamilyHue;
                SHADES.forEach(s => {
                    const val = getVal(fam, s);
                    if (!val) return;
                    const lc = parseLCH(val);
                    if (!lc) return;
                    let h = lc.h + delta;
                    while (h < 0) h += 360;
                    while (h >= 360) h -= 360;
                    lc.h = h;
                    setVal(fam, s, fmtLCH(lc.l, lc.c, lc.h));
                });
                lastFamilyHue = newHue;
                saveHistoryDebounced(`Shift ${fam} by ${delta > 0 ? '+' : ''}${Math.round(delta)}¬∞`);
            }

            render();
            broadcastColorChange();
        }

        // Broadcast color changes to other windows (like token-preview)
        function broadcastColorChange() {
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({
                    type: 'COLORS_UPDATED',
                    colors: state.tokens,
                    source: 'palette-generator'
                }, '*');
            }
            // Also broadcast to any child windows
            const msg = { type: 'COLORS_UPDATED', colors: state.tokens, source: 'palette-generator' };
            window.postMessage(msg, '*');
        }

        function loadFile() { document.getElementById('fileIn').click(); }

        function handleFile(e) {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = ev => {
                try {
                    state.tokens = JSON.parse(ev.target.result);
                    render();
                    toast('Loaded ' + f.name);
                } catch (err) {
                    toast('Error: ' + err.message);
                }
            };
            r.readAsText(f);
        }

        function showExport() { document.getElementById('exportModal').classList.add('open'); updExport(); }
        function closeExport() { document.getElementById('exportModal').classList.remove('open'); }

        function setTab(t, el) {
            state.tab = t;
            document.querySelectorAll('.modal-tab').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            updExport();
        }

        function updExport() {
            let code = '';
            if (state.tab === 'lch') {
                code = JSON.stringify(state.tokens, null, 2);
            } else if (state.tab === 'hex') {
                // Generate HEX JSON in same structure as LCH
                const hexTokens = {};
                Object.keys(state.tokens).forEach(fam => {
                    if (fam === 'pure') {
                        hexTokens.pure = {};
                        Object.keys(state.tokens.pure).forEach(k => {
                            if (k.startsWith('$')) return;
                            const v = state.tokens.pure[k].$value;
                            const lc = parseLCH(v);
                            const d = getDisplay(lc);
                            hexTokens.pure[k] = {
                                "$type": "color",
                                "$value": d.hex
                            };
                        });
                    } else {
                        hexTokens[fam] = { "$type": "color" };
                        SHADES.forEach(s => {
                            const v = getVal(fam, s);
                            if (!v) return;
                            const lc = parseLCH(v), d = getDisplay(lc);
                            hexTokens[fam][s] = { "$value": d.hex };
                        });
                    }
                });
                code = JSON.stringify(hexTokens, null, 2);
            } else if (state.tab === 'csslch') {
                const l = [':root {'];
                getFams().forEach(f => {
                    l.push(`  /* ${f} */`);
                    SHADES.forEach(s => {
                        const v = getVal(f, s);
                        if (!v) return;
                        const lc = parseLCH(v);
                        if (lc) {
                            l.push(`  --color-${f}-${s}: lch(${lc.l}% ${lc.c} ${lc.h});`);
                        }
                    });
                });
                l.push('}');
                code = l.join('\n');
            }
            document.getElementById('exportCode').textContent = code;

            // Show/hide save button based on tab
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.style.display = (state.tab === 'lch' || state.tab === 'hex') ? 'block' : 'none';
                saveBtn.textContent = state.tab === 'lch' ? 'Save colors_lch_new.json' : 'Save colors_hex_new.json';
            }
        }

        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('exportCode').textContent);
            toast('Copied!');
        }

        function downloadCode() {
            const c = document.getElementById('exportCode').textContent;
            const ext = { lch: 'json', hex: 'json', csslch: 'css' };
            const names = { lch: 'colors_lch_new', hex: 'colors_hex_new', csslch: 'colors_lch' };
            const b = new Blob([c], { type: 'text/plain' });
            const u = URL.createObjectURL(b);
            const a = document.createElement('a');
            a.href = u;
            a.download = `${names[state.tab]}.${ext[state.tab]}`;
            a.click();
            URL.revokeObjectURL(u);
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        async function saveToFile() {
            const code = document.getElementById('exportCode').textContent;
            const filename = state.tab === 'lch' ? 'colors_lch_new.json' : 'colors_hex_new.json';
            const path = `../design-tokens/core/${filename}`;

            try {
                // Try using File System Access API (modern browsers)
                if ('showSaveFilePicker' in window) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'JSON files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(code);
                    await writable.close();
                    toast(`Saved ${filename}`);
                } else {
                    // Fallback to download
                    downloadCode();
                    toast('File downloaded (save to design-tokens/core/ manually)');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    toast('Error: ' + err.message);
                }
            }
        }

        // Open token-preview in sync mode
        let tokenPreviewWindow = null;
        function openTokenPreview() {
            if (tokenPreviewWindow && !tokenPreviewWindow.closed) {
                tokenPreviewWindow.focus();
                toast('Token Preview already open');
                return;
            }
            tokenPreviewWindow = window.open('token-preview.html', 'tokenPreview', 'width=1400,height=900');
            toast('Opening Token Preview...');
        }

        // Compare modal functions
        function showCompareModal() {
            if (!state.oldTokens) {
                toast('No baseline loaded for comparison');
                return;
            }
            document.getElementById('compareModal').classList.add('open');
            renderCompareContent();
        }

        function closeCompareModal() {
            document.getElementById('compareModal').classList.remove('open');
        }

        function setCompareView(view, el) {
            state.compareView = view;
            document.querySelectorAll('#compareModal .compare-tab').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderCompareContent();
        }

        function toggleShowOnlyChanges(show) {
            state.showOnlyChanges = show;
            renderCompareContent();
        }

        function getAllChanges() {
            const changes = [];
            getFams().forEach(f => {
                SHADES.forEach(s => {
                    const newV = getVal(f, s);
                    const oldV = getOldVal(f, s);
                    if (!newV) return;
                    const delta = getDelta(newV, oldV);
                    if (delta?.hasChange || delta?.isNew) {
                        changes.push({ family: f, shade: s, newV, oldV, delta });
                    }
                });
            });
            return changes;
        }

        function renderCompareContent() {
            const container = document.getElementById('compareContent');
            const changes = getAllChanges();

            if (state.compareView === 'visual') {
                // Visual side-by-side comparison
                container.innerHTML = `
                    <div class="compare-toolbar">
                        <div class="compare-info">
                            <strong>${changes.length}</strong> colors changed ¬∑ Top row = Main (old) ¬∑ Bottom row = New
                        </div>
                        <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-2);cursor:pointer">
                            <input type="checkbox" id="showOnlyChanges" ${state.showOnlyChanges ? 'checked' : ''} onchange="toggleShowOnlyChanges(this.checked)" style="accent-color:var(--accent);width:16px;height:16px">
                            Show only changes
                        </label>
                    </div>
                    <div class="compare-scroll">
                        <div class="full-compare">
                            <div class="full-compare-header">
                                ${SHADES.map(s => `<span>${s}</span>`).join('')}
                            </div>
                        ${getFams().map(f => {
                    // Check if family has any changes
                    const famHasChanges = SHADES.some(s => {
                        const delta = getDelta(getVal(f, s), getOldVal(f, s));
                        return delta?.hasChange || delta?.isNew;
                    });

                    // Skip family if showing only changes and no changes
                    if (state.showOnlyChanges && !famHasChanges) return '';

                    return `
                            <div class="full-compare-row">
                                <div class="full-compare-label">${f}</div>
                                <div class="full-compare-shades">
                                    ${SHADES.map(s => {
                        const newV = getVal(f, s);
                        const oldV = getOldVal(f, s);
                        const delta = getDelta(newV, oldV);
                        const isChanged = delta?.hasChange || delta?.isNew;

                        // Skip unchanged if showing only changes
                        if (state.showOnlyChanges && !isChanged) {
                            return '<div class="compare-shade-pair" style="width:44px"></div>';
                        }

                        if (!newV && !oldV) return '<div class="compare-shade-pair" style="opacity:0.2"><div class="compare-shade old" style="background:var(--bg-3)">-</div><div class="compare-shade new" style="background:var(--bg-3)">-</div></div>';

                        const newLc = parseLCH(newV);
                        const oldLc = parseLCH(oldV);
                        const newD = getDisplay(newLc);
                        const oldD = oldV ? getDisplay(oldLc) : { css: 'var(--bg-3)', rgb: null };
                        const newTc = txtCol(newD.rgb);
                        const oldTc = oldV ? txtCol(oldD.rgb) : 'var(--text-3)';

                        return `<div class="compare-shade-pair ${isChanged ? '' : 'same'}" onclick="pick('${f}','${s}');closeCompareModal()" title="${f}-${s}${isChanged ? ' (changed)' : ''}">
                                            <div class="compare-shade old" style="background:${oldD.css};color:${oldTc}">${oldLc ? Math.round(oldLc.l) : '‚Äî'}</div>
                                            <div class="compare-shade new" style="background:${newD.css};color:${newTc}">${newLc ? Math.round(newLc.l) : '‚Äî'}</div>
                                        </div>`;
                    }).join('')}
                                </div>
                            </div>`;
                }).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Changes list view
                if (changes.length === 0) {
                    container.innerHTML = `
                        <div class="no-changes">
                            <div class="no-changes-icon">‚úì</div>
                            <div>No changes from main</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="compare-toolbar">
                        <div class="compare-info"><strong>${changes.length}</strong> color${changes.length !== 1 ? 's' : ''} changed</div>
                    </div>
                    <div class="compare-scroll">
                        <div class="changes-list" style="max-height:none">
                            ${changes.map(c => {
                    const newLc = parseLCH(c.newV);
                    const oldLc = parseLCH(c.oldV);
                    const newD = getDisplay(newLc);
                    const oldD = c.oldV ? getDisplay(oldLc) : null;

                    let deltaText = '';
                    if (c.delta.isNew) {
                        deltaText = 'New color';
                    } else {
                        const parts = [];
                        if (c.delta.dL !== 0) parts.push(`L${c.delta.dL > 0 ? '+' : ''}${c.delta.dL}`);
                        if (c.delta.dC !== 0) parts.push(`C${c.delta.dC > 0 ? '+' : ''}${c.delta.dC}`);
                        if (c.delta.dH !== 0) parts.push(`H${c.delta.dH > 0 ? '+' : ''}${c.delta.dH}¬∞`);
                        deltaText = parts.join(' ');
                    }

                    return `<div class="change-item" onclick="pick('${c.family}','${c.shade}');closeCompareModal()">
                                    <div class="change-swatches">
                                        ${oldD ? `<div class="change-swatch" style="background:${oldD.css}"></div>` : '<div class="change-swatch" style="background:var(--bg-3)"></div>'}
                                        <span class="change-arrow">‚Üí</span>
                                        <div class="change-swatch" style="background:${newD.css}"></div>
                                    </div>
                                    <div class="change-info">
                                        <div class="change-name">${c.family}-${c.shade}</div>
                                        <div class="change-delta">${deltaText}</div>
                                    </div>
                                </div>`;
                }).join('')}
                        </div>
                    </div>
                `;
            }
        }

        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT') return;
            if (e.key === 'e' || e.key === 'E') showExport();
            if (e.key === 'l' || e.key === 'L') loadFile();
            if (e.key === 'Escape') { closeExport(); closeCompareModal(); }
            if (e.key === 'c' || e.key === 'C') { if (state.oldTokens) showCompareModal(); }
        });

        // Load both JSON files on startup
        async function loadColorFiles() {
            try {
                // Load old tokens from main (colors_lch.json)
                const oldRes = await fetch('../design-tokens/core/colors_lch.json');
                if (oldRes.ok) {
                    state.oldTokens = await oldRes.json();
                    console.log('Loaded colors_lch.json (main branch)');
                }
            } catch (e) {
                console.warn('Could not load colors_lch.json:', e);
            }

            try {
                // Load new tokens (colors_lch_new.json) - this is what we edit
                const newRes = await fetch('../design-tokens/core/colors_lch_new.json');
                if (newRes.ok) {
                    state.tokens = await newRes.json();
                    console.log('Loaded colors_lch_new.json (editable)');
                }
            } catch (e) {
                console.warn('Could not load colors_lch_new.json, using fallback:', e);
            }

            render();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Skip if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Ctrl+Z / Cmd+Z = Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Y / Cmd+Shift+Z = Redo
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redo();
            }
            // 1 = Shade mode
            if (e.key === '1') {
                e.preventDefault();
                setHueMode('shade');
            }
            // 2 = All mode
            if (e.key === '2') {
                e.preventDefault();
                setHueMode('all');
            }
            // 3 = Shift mode
            if (e.key === '3') {
                e.preventDefault();
                setHueMode('shift');
            }
        });

        checkP3();
        lucide.createIcons();
        loadColorFiles().then(() => {
            initHistory();
        });
    </script>
</body>

</html>